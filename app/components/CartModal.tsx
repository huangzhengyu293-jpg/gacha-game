'use client';

import { useState, useEffect, useRef, useMemo, type MouseEvent as ReactMouseEvent } from 'react';
import { useMutation, useQueryClient, useQuery } from '@tanstack/react-query';
import { api } from '../lib/api';
import { useCart } from '../hooks/useCart';
import { showGlobalToast } from './ToastProvider';
import { useAuth } from '../hooks/useAuth';

// ğŸ¯ å®šä¹‰WarehouseItemç±»å‹
interface WarehouseItem {
  id: string;
  productId: string;
  name: string;
  price: number;
  image: string;
  quantity?: number;
}
interface CartItem {
  id: string; // unique key per card, may include suffix
  warehouseId?: string; // actual warehouse id for API
  productId: string; // warehouse productId key
  name: string;
  price: number;
  image: string;
  selected?: boolean;
}

interface CartModalProps {
  isOpen: boolean;
  onClose: () => void;
  totalPrice?: number;
  items?: CartItem[];
}

function buildVoucherSvg(price: number): string {
  const amount = `${price.toFixed(2)}`;
  return `
<svg viewBox="0 0 192 192" xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" preserveAspectRatio="xMidYMid meet">
<g transform="translate(96 96) scale(1.18) translate(-96 -96)">
<path d="M0 0 C6.35833053 0.95989289 11.96607353 3.92377655 17.68185425 6.72766113 C20.50146947 8.11041109 23.33528122 9.46290284 26.16844177 10.81762695 C27.64990777 11.52628445 29.13066558 12.23642424 30.61073303 12.94799805 C38.07413944 16.53160178 45.60905111 19.9489984 53.15625 23.3515625 C68.17142406 30.13569574 83.11929426 37.06216483 98.05444336 44.02050781 C99.33654442 44.61676468 99.33654442 44.61676468 100.64454651 45.22506714 C102.25378132 45.97346207 103.86240642 46.72316991 105.47032166 47.47439575 C108.36193784 48.81830639 111.19087213 50.09226988 114.21875 51.1015625 C114.54875 54.0715625 114.87875 57.0415625 115.21875 60.1015625 C116.53875 60.4315625 117.85875 60.7615625 119.21875 61.1015625 C119.8035705 66.71583932 118.76613349 69.30760039 115.59765625 73.90234375 C113.21312436 77.70543569 111.75944672 81.90122731 110.21875 86.1015625 C109.55875 86.1015625 108.89875 86.1015625 108.21875 86.1015625 C108.21875 87.7515625 108.21875 89.4015625 108.21875 91.1015625 C107.22875 91.5965625 107.22875 91.5965625 106.21875 92.1015625 C105.49181096 94.08045211 104.82058749 96.08110808 104.21875 98.1015625 C103.55875 98.1015625 102.89875 98.1015625 102.21875 98.1015625 C102.26 98.8853125 102.30125 99.6690625 102.34375 100.4765625 C102.21875 103.1015625 102.21875 103.1015625 100.21875 105.1015625 C99.09083341 107.80856232 98.05507593 110.54089816 97.03125 113.2890625 C94.61757389 117.03442198 92.43037541 117.08765268 88.21875 118.1015625 C87.88875 119.0915625 87.55875 120.0815625 87.21875 121.1015625 C84.27485218 122.27912163 83.31921087 122.13504946 80.21875 121.1015625 C80.11433594 121.62878906 80.00992188 122.15601563 79.90234375 122.69921875 C79.01432416 125.81997332 77.66783136 128.60656157 76.28125 131.5390625 C74.48007777 135.35825571 72.7427065 139.16283434 71.21875 143.1015625 C70.55875 143.1015625 69.89875 143.1015625 69.21875 143.1015625 C68.88875 144.7515625 68.55875 146.4015625 68.21875 148.1015625 C62.46875 150.1015625 62.46875 150.1015625 60.21875 150.1015625 C59.88875 151.4215625 59.55875 152.7415625 59.21875 154.1015625 C52.97420189 156.476276 46.09659724 151.8332104 40.36889648 149.2755127 C36.42287108 147.47779846 32.50711581 145.61809192 28.59637451 143.74508667 C24.8690518 141.96076418 21.13372561 140.19335398 17.3984375 138.42578125 C16.25110641 137.88247917 16.25110641 137.88247917 15.08059692 137.32820129 C7.96258363 133.96518171 0.80221929 130.69951795 -6.37191772 127.45831299 C-17.78958165 122.29903136 -29.19802786 117.11832805 -40.56488037 111.84793091 C-41.98995063 111.18870114 -43.41640874 110.53246251 -44.84429932 109.87936401 C-46.81541003 108.97710735 -48.78124746 108.06423925 -50.74609375 107.1484375 C-51.8662085 106.63120117 -52.98632324 106.11396484 -54.14038086 105.58105469 C-56.78125 104.1015625 -56.78125 104.1015625 -58.78125 101.1015625 C-58.90625 98.4140625 -58.90625 98.4140625 -58.78125 96.1015625 C-60.10125 95.4415625 -61.42125 94.7815625 -62.78125 94.1015625 C-63.13175464 88.2598185 -62.94852335 84.2483817 -59.78125 79.1015625 C-59.12125 79.1015625 -58.46125 79.1015625 -57.78125 79.1015625 C-57.45125 76.7915625 -57.12125 74.4815625 -56.78125 72.1015625 C-56.12125 72.1015625 -55.46125 72.1015625 -54.78125 72.1015625 C-54.843125 71.4209375 -54.905 70.7403125 -54.96875 70.0390625 C-54.72256737 66.18220125 -53.42322838 63.59076656 -51.78125 60.1015625 C-51.12125 60.1015625 -50.46125 60.1015625 -49.78125 60.1015625 C-49.78125 58.4515625 -49.78125 56.8015625 -49.78125 55.1015625 C-49.12125 55.1015625 -48.46125 55.1015625 -47.78125 55.1015625 C-47.8225 54.3178125 -47.86375 53.5340625 -47.90625 52.7265625 C-47.78125 50.1015625 -47.78125 50.1015625 -45.78125 48.1015625 C-45.13357207 45.53094939 -45.13357207 45.53094939 -44.78125 43.1015625 C-44.12125 43.1015625 -43.46125 43.1015625 -42.78125 43.1015625 C-42.678125 42.1734375 -42.575 41.2453125 -42.46875 40.2890625 C-41.78125 37.1015625 -41.78125 37.1015625 -40.53125 35.1640625 C-38.04758982 33.65612596 -36.52910755 34.46744153 -33.78125 35.1015625 C-33.12125 34.4415625 -32.46125 33.7815625 -31.78125 33.1015625 C-28.15625 32.9765625 -28.15625 32.9765625 -24.78125 33.1015625 C-24.843125 32.4003125 -24.905 31.6990625 -24.96875 30.9765625 C-24.73868899 27.44896038 -23.48924432 25.16171899 -21.78125 22.1015625 C-21.12125 22.1015625 -20.46125 22.1015625 -19.78125 22.1015625 C-19.843125 21.4209375 -19.905 20.7403125 -19.96875 20.0390625 C-19.72256737 16.18220125 -18.42322838 13.59076656 -16.78125 10.1015625 C-16.12125 10.1015625 -15.46125 10.1015625 -14.78125 10.1015625 C-14.8225 9.3178125 -14.86375 8.5340625 -14.90625 7.7265625 C-14.78125 5.1015625 -14.78125 5.1015625 -12.78125 3.1015625 C-11.3271875 3.1325 -11.3271875 3.1325 -9.84375 3.1640625 C-6.78907855 3.46061186 -6.78907855 3.46061186 -5.32617188 1.60400391 C-3.78125 0.1015625 -3.78125 0.1015625 0 0 Z " fill="#7E7E7E" transform="translate(67.78125,19.8984375)"/>
<path d="M0 0 C7.72418724 0.32729607 13.54784906 3.36772453 20.375 6.8125 C22.17294332 7.69911487 23.97090771 8.58569057 25.7702179 9.4695282 C27.00396571 10.07565161 28.23710613 10.68301286 29.46965027 11.2915802 C39.872566 16.41991053 50.44535291 21.19411736 61 26 C61.90234375 26.41185547 62.8046875 26.82371094 63.734375 27.24804688 C66.17437514 28.35898633 68.61749551 29.46262509 71.0625 30.5625 C71.74578369 30.87292236 72.42906738 31.18334473 73.13305664 31.50317383 C77.34571187 33.38099094 81.59875649 34.89416556 85.9855957 36.31469727 C89.52759409 37.51968932 92.69697381 39.25840437 96 41 C96 41.66 96 42.32 96 43 C97.36125 43.433125 97.36125 43.433125 98.75 43.875 C99.8225 44.24625 100.895 44.6175 102 45 C102.763125 45.2475 103.52625 45.495 104.3125 45.75 C106 47 106 47 106.74365234 49.75073242 C107.03502967 53.44400946 106.48169822 54.98644783 104.7890625 58.23828125 C104.04112427 59.70479126 104.04112427 59.70479126 103.27807617 61.20092773 C102.73256104 62.22774658 102.1870459 63.25456543 101.625 64.3125 C101.07497314 65.36961182 100.52494629 66.42672363 99.95825195 67.51586914 C98.84097364 69.66036194 97.7180341 71.80191508 96.58935547 73.94042969 C95.15024595 76.71077078 93.78112431 79.50092994 92.44140625 82.3203125 C92.05710449 83.10752686 91.67280273 83.89474121 91.27685547 84.70581055 C90.56861253 86.15674033 89.87775475 87.61633134 89.20751953 89.08520508 C88.23046875 91.02734375 88.23046875 91.02734375 86 94 C81.9630769 95.14900428 79.9861671 95.4287683 76.125 93.75 C74.578125 92.88375 74.578125 92.88375 73 92 C71.71535603 91.58193698 70.42257803 91.18850273 69.125 90.8125 C61.71865519 88.46694502 54.88113248 84.55454819 48 81 C48 80.34 48 79.68 48 79 C47.1227124 78.72470459 46.2454248 78.44940918 45.34155273 78.16577148 C42.24396039 77.08511075 39.45483372 75.83446452 36.53515625 74.34765625 C34.98078857 73.56177124 34.98078857 73.56177124 33.39501953 72.76000977 C32.29528809 72.19983154 31.19555664 71.63965332 30.0625 71.0625 C21.29364864 66.63359374 12.49851782 62.27801096 3.625 58.0625 C-3.96071129 54.45799705 -11.51675861 50.81403916 -19 47 C-19.42788974 41.00215774 -18.10053204 36.99443903 -15.60546875 31.58203125 C-15.25744705 30.80236496 -14.90942535 30.02269867 -14.55085754 29.21940613 C-13.81629944 27.5804496 -13.07551313 25.94427176 -12.32885742 24.31079102 C-11.18887429 21.81550816 -10.06851508 19.31213117 -8.95117188 16.80664062 C-8.23290094 15.21042849 -7.51353681 13.61470773 -6.79296875 12.01953125 C-6.45847214 11.27467972 -6.12397552 10.52982819 -5.77934265 9.7624054 C-4.14674218 6.203228 -2.54495462 3.02019648 0 0 Z " fill="#80807F" transform="translate(39,65)"/>
<path d="M0 0 C6.35833053 0.95989289 11.96607353 3.92377655 17.68185425 6.72766113 C20.50146947 8.11041109 23.33528122 9.46290284 26.16844177 10.81762695 C27.64990777 11.52628445 29.13066558 12.23642424 30.61073303 12.94799805 C38.07413944 16.53160178 45.60905111 19.9489984 53.15625 23.3515625 C68.17142406 30.13569574 83.11929426 37.06216483 98.05444336 44.02050781 C99.33654442 44.61676468 99.33654442 44.61676468 100.64454651 45.22506714 C102.25378132 45.97346207 103.86240642 46.72316991 105.47032166 47.47439575 C108.36193784 48.81830639 111.19087213 50.09226988 114.21875 51.1015625 C114.54875 54.0715625 114.87875 57.0415625 115.21875 60.1015625 C116.53875 60.4315625 117.85875 60.7615625 119.21875 61.1015625 C119.8035705 66.71583932 118.76613349 69.30760039 115.59765625 73.90234375 C113.21312436 77.70543569 111.75944672 81.90122731 110.21875 86.1015625 C109.55875 86.1015625 108.89875 86.1015625 108.21875 86.1015625 C108.21875 87.7515625 108.21875 89.4015625 108.21875 91.1015625 C107.22875 91.5965625 107.22875 91.5965625 106.21875 92.1015625 C105.49181096 94.08045211 104.82058749 96.08110808 104.21875 98.1015625 C103.55875 98.1015625 102.89875 98.1015625 102.21875 98.1015625 C102.26 98.8853125 102.30125 99.6690625 102.34375 100.4765625 C102.21875 103.1015625 102.21875 103.1015625 100.21875 105.1015625 C99.09083341 107.80856232 98.05507593 110.54089816 97.03125 113.2890625 C94.61757389 117.03442198 92.43037541 117.08765268 88.21875 118.1015625 C87.88875 119.0915625 87.55875 120.0815625 87.21875 121.1015625 C84.27485218 122.27912163 83.31921087 122.13504946 80.21875 121.1015625 C80.11433594 121.62878906 80.00992188 122.15601563 79.90234375 122.69921875 C79.01432416 125.81997332 77.66783136 128.60656157 76.28125 131.5390625 C74.48007777 135.35825571 72.7427065 139.16283434 71.21875 143.1015625 C70.55875 143.1015625 69.89875 143.1015625 69.21875 143.1015625 C68.88875 144.7515625 68.55875 146.4015625 68.21875 148.1015625 C62.46875 150.1015625 62.46875 150.1015625 60.21875 150.1015625 C59.88875 151.4215625 59.55875 152.7415625 59.21875 154.1015625 C52.97420189 156.476276 46.09659724 151.8332104 40.36889648 149.2755127 C36.42287108 147.47779846 32.50711581 145.61809192 28.59637451 143.74508667 C24.8690518 141.96076418 21.13372561 140.19335398 17.3984375 138.42578125 C16.25110641 137.88247917 16.25110641 137.88247917 15.08059692 137.32820129 C7.96258363 133.96518171 0.80221929 130.69951795 -6.37191772 127.45831299 C-17.78958165 122.29903136 -29.19802786 117.11832805 -40.56488037 111.84793091 C-41.98995063 111.18870114 -43.41640874 110.53246251 -44.84429932 109.87936401 C-46.81541003 108.97710735 -48.78124746 108.06423925 -50.74609375 107.1484375 C-51.8662085 106.63120117 -52.98632324 106.11396484 -54.14038086 105.58105469 C-56.78125 104.1015625 -56.78125 104.1015625 -58.78125 101.1015625 C-58.90625 98.4140625 -58.90625 98.4140625 -58.78125 96.1015625 C-60.10125 95.4415625 -61.42125 94.7815625 -62.78125 94.1015625 C-63.13175464 88.2598185 -62.94852335 84.2483817 -59.78125 79.1015625 C-59.12125 79.1015625 -58.46125 79.1015625 -57.78125 79.1015625 C-57.45125 76.7915625 -57.12125 74.4815625 -56.78125 72.1015625 C-56.12125 72.1015625 -55.46125 72.1015625 -54.78125 72.1015625 C-54.843125 71.4209375 -54.905 70.7403125 -54.96875 70.0390625 C-54.72256737 66.18220125 -53.42322838 63.59076656 -51.78125 60.1015625 C-51.12125 60.1015625 -50.46125 60.1015625 -49.78125 60.1015625 C-49.78125 58.4515625 -49.78125 56.8015625 -49.78125 55.1015625 C-49.12125 55.1015625 -48.46125 55.1015625 -47.78125 55.1015625 C-47.8225 54.3178125 -47.86375 53.5340625 -47.90625 52.7265625 C-47.78125 50.1015625 -47.78125 50.1015625 -45.78125 48.1015625 C-45.13357207 45.53094939 -45.13357207 45.53094939 -44.78125 43.1015625 C-44.12125 43.1015625 -43.46125 43.1015625 -42.78125 43.1015625 C-42.678125 42.1734375 -42.575 41.2453125 -42.46875 40.2890625 C-41.78125 37.1015625 -41.78125 37.1015625 -40.53125 35.1640625 C-38.04758982 33.65612596 -36.52910755 34.46744153 -33.78125 35.1015625 C-33.12125 34.4415625 -32.46125 33.7815625 -31.78125 33.1015625 C-28.15625 32.9765625 -28.15625 32.9765625 -24.78125 33.1015625 C-24.843125 32.4003125 -24.905 31.6990625 -24.96875 30.9765625 C-24.73868899 27.44896038 -23.48924432 25.16171899 -21.78125 22.1015625 C-21.12125 22.1015625 -20.46125 22.1015625 -19.78125 22.1015625 C-19.843125 21.4209375 -19.905 20.7403125 -19.96875 20.0390625 C-19.72256737 16.18220125 -18.42322838 13.59076656 -16.78125 10.1015625 C-16.12125 10.1015625 -15.46125 10.1015625 -14.78125 10.1015625 C-14.8225 9.3178125 -14.86375 8.5340625 -14.90625 7.7265625 C-14.78125 5.1015625 -14.78125 5.1015625 -12.78125 3.1015625 C-11.3271875 3.1325 -11.3271875 3.1325 -9.84375 3.1640625 C-6.78907855 3.46061186 -6.78907855 3.46061186 -5.32617188 1.60400391 C-3.78125 0.1015625 -3.78125 0.1015625 0 0 Z M-1.78125 1.1015625 C-2.11125 2.0915625 -2.44125 3.0815625 -2.78125 4.1015625 C-5.42125 4.1015625 -8.06125 4.1015625 -10.78125 4.1015625 C-11.0793924 7.8779557 -11.0793924 7.8779557 -9.78125 10.1015625 C-11.10125 10.1015625 -12.42125 10.1015625 -13.78125 10.1015625 C-14.55367269 11.93857039 -14.55367269 11.93857039 -14.78125 14.1015625 C-13.42680699 15.87347159 -13.42680699 15.87347159 -11.78125 17.1015625 C-13.43125 17.1015625 -15.08125 17.1015625 -16.78125 17.1015625 C-16.78125 18.0915625 -16.78125 19.0815625 -16.78125 20.1015625 C-16.12125 20.1015625 -15.46125 20.1015625 -14.78125 20.1015625 C-15.11125 20.7615625 -15.44125 21.4215625 -15.78125 22.1015625 C-17.84375 22.7265625 -17.84375 22.7265625 -19.78125 23.1015625 C-19.78125 23.7615625 -19.78125 24.4215625 -19.78125 25.1015625 C-19.12125 25.1015625 -18.46125 25.1015625 -17.78125 25.1015625 C-17.78125 26.0915625 -17.78125 27.0815625 -17.78125 28.1015625 C-19.10125 28.1015625 -20.42125 28.1015625 -21.78125 28.1015625 C-21.12125 29.7515625 -20.46125 31.4015625 -19.78125 33.1015625 C-21.10125 33.1015625 -22.42125 33.1015625 -23.78125 33.1015625 C-23.78125 33.7615625 -23.78125 34.4215625 -23.78125 35.1015625 C-24.709375 34.8746875 -25.6375 34.6478125 -26.59375 34.4140625 C-29.74951848 33.73836267 -29.74951848 33.73836267 -31.65625 35.5390625 C-32.0275 36.0546875 -32.39875 36.5703125 -32.78125 37.1015625 C-34.43125 36.4415625 -36.08125 35.7815625 -37.78125 35.1015625 C-38.77125 37.5765625 -38.77125 37.5765625 -39.78125 40.1015625 C-38.79125 41.0915625 -37.80125 42.0815625 -36.78125 43.1015625 C-38.43125 43.1015625 -40.08125 43.1015625 -41.78125 43.1015625 C-42.11125 44.4215625 -42.44125 45.7415625 -42.78125 47.1015625 C-41.79125 47.1015625 -40.80125 47.1015625 -39.78125 47.1015625 C-39.78125 48.0915625 -39.78125 49.0815625 -39.78125 50.1015625 C-41.43125 50.1015625 -43.08125 50.1015625 -44.78125 50.1015625 C-44.78125 51.0915625 -44.78125 52.0815625 -44.78125 53.1015625 C-44.12125 53.1015625 -43.46125 53.1015625 -42.78125 53.1015625 C-43.11125 53.7615625 -43.44125 54.4215625 -43.78125 55.1015625 C-44.77125 55.1015625 -45.76125 55.1015625 -46.78125 55.1015625 C-46.45125 56.7515625 -46.12125 58.4015625 -45.78125 60.1015625 C-47.10125 60.7615625 -48.42125 61.4215625 -49.78125 62.1015625 C-49.12125 63.4215625 -48.46125 64.7415625 -47.78125 66.1015625 C-49.76125 66.5965625 -49.76125 66.5965625 -51.78125 67.1015625 C-51.45125 69.0815625 -51.12125 71.0615625 -50.78125 73.1015625 C-52.76125 73.5965625 -52.76125 73.5965625 -54.78125 74.1015625 C-54.78125 75.0915625 -54.78125 76.0815625 -54.78125 77.1015625 C-54.12125 77.1015625 -53.46125 77.1015625 -52.78125 77.1015625 C-54.03666557 79.61239364 -55.28188488 79.97281696 -57.78125 81.1015625 C-57.12125 82.4215625 -56.46125 83.7415625 -55.78125 85.1015625 C-57.10125 85.1015625 -58.42125 85.1015625 -59.78125 85.1015625 C-59.78125 86.4215625 -59.78125 87.7415625 -59.78125 89.1015625 C-58.46125 89.7615625 -57.14125 90.4215625 -55.78125 91.1015625 C-55.78125 93.4115625 -55.78125 95.7215625 -55.78125 98.1015625 C-46.05004756 103.04675634 -36.26109279 107.79098522 -26.30130005 112.25765991 C-22.72707762 113.86142436 -19.15831973 115.47724783 -15.58984375 117.09375 C-14.85902084 117.42475204 -14.12819794 117.75575409 -13.37522888 118.0967865 C-5.66719168 121.59521848 1.99688024 125.18562071 9.65625 128.7890625 C10.98018704 129.41113141 12.30416141 130.03312086 13.62817383 130.6550293 C16.21901139 131.87218606 18.80974648 133.08956053 21.40039062 134.30712891 C22.03066162 134.60331116 22.66093262 134.89949341 23.31030273 135.20465088 C24.58786946 135.80506802 25.86537549 136.40561432 27.14282227 137.00628662 C31.39359484 139.00436619 35.64892941 140.99246037 39.90625 142.9765625 C41.51874634 143.7358606 41.51874634 143.7358606 43.16381836 144.51049805 C44.15518799 144.97109619 45.14655762 145.43169434 46.16796875 145.90625 C47.02737061 146.30827637 47.88677246 146.71030273 48.7722168 147.12451172 C51.24990588 148.11400495 53.59181711 148.66525734 56.21875 149.1015625 C56.775625 148.1425 56.775625 148.1425 57.34375 147.1640625 C57.9625 146.4834375 58.58125 145.8028125 59.21875 145.1015625 C60.641875 145.070625 60.641875 145.070625 62.09375 145.0390625 C65.37734854 144.43449088 65.37734854 144.43449088 66.6484375 141.7421875 C67.9239082 138.88935953 69.08250486 136.01216147 70.21875 133.1015625 C70.78335938 131.99748047 70.78335938 131.99748047 71.359375 130.87109375 C72.36436935 129.12958104 72.36436935 129.12958104 72.21875 127.1015625 C72.96125 126.4209375 72.96125 126.4209375 73.71875 125.7265625 C75.67093674 123.98027283 75.67093674 123.98027283 75.21875 120.1015625 C75.87875 119.7715625 76.53875 119.4415625 77.21875 119.1015625 C77.21875 117.7815625 77.21875 116.4615625 77.21875 115.1015625 C79.52875 115.4315625 81.83875 115.7615625 84.21875 116.1015625 C84.404375 115.4828125 84.59 114.8640625 84.78125 114.2265625 C86.21875 112.1015625 86.21875 112.1015625 89.71875 111.1640625 C93.33625444 110.49530037 93.33625444 110.49530037 94.59375 107.7890625 C95.18849483 105.23165971 95.77505861 102.68976229 96.21875 100.1015625 C96.87875 100.1015625 97.53875 100.1015625 98.21875 100.1015625 C98.54875 97.7915625 98.87875 95.4815625 99.21875 93.1015625 C100.20875 92.7715625 101.19875 92.4415625 102.21875 92.1015625 C101.88875 90.4515625 101.55875 88.8015625 101.21875 87.1015625 C102.53875 86.7715625 103.85875 86.4415625 105.21875 86.1015625 C105.21875 84.7815625 105.21875 83.4615625 105.21875 82.1015625 C106.71875 80.3515625 106.71875 80.3515625 108.21875 79.1015625 C107.88875 78.1115625 107.55875 77.1215625 107.21875 76.1015625 C108.20875 76.1015625 109.19875 76.1015625 110.21875 76.1015625 C110.21875 74.4515625 110.21875 72.8015625 110.21875 71.1015625 C111.20875 70.7715625 112.19875 70.4415625 113.21875 70.1015625 C113.54875 69.1115625 113.87875 68.1215625 114.21875 67.1015625 C113.55875 67.1015625 112.89875 67.1015625 112.21875 67.1015625 C112.21875 66.1115625 112.21875 65.1215625 112.21875 64.1015625 C113.53875 64.1015625 114.85875 64.1015625 116.21875 64.1015625 C116.21875 63.1115625 116.21875 62.1215625 116.21875 61.1015625 C115.2596875 60.823125 115.2596875 60.823125 114.28125 60.5390625 C113.600625 60.0646875 112.92 59.5903125 112.21875 59.1015625 C112.15171875 57.99683594 112.0846875 56.89210937 112.015625 55.75390625 C111.59421884 51.88542856 111.59421884 51.88542856 108.32421875 49.984375 C107.03097801 49.3708117 105.72351246 48.78669744 104.40625 48.2265625 C103.69897263 47.90019302 102.99169525 47.57382355 102.26298523 47.23756409 C99.9256857 46.16645552 97.57316049 45.13444666 95.21875 44.1015625 C93.5715497 43.3552565 91.92548424 42.60644107 90.28051758 41.85522461 C86.90269006 40.31798941 83.5184969 38.79640295 80.12744141 37.28857422 C75.69138648 35.31602122 71.27026556 33.31258133 66.85546875 31.29296875 C62.88436116 29.47776427 58.91247968 27.6645985 54.93261719 25.86865234 C47.1534801 22.35783822 39.39746851 18.80137581 31.66015625 15.19921875 C30.7691069 14.78505203 29.87805756 14.37088531 28.96000671 13.94416809 C21.80451665 10.61818466 21.80451665 10.61818466 18.37411499 9.01077271 C15.94428317 7.872263 13.51150548 6.74027548 11.078125 5.609375 C10.35569107 5.26846329 9.63325714 4.92755157 8.88893127 4.5763092 C5.35621902 2.94145142 2.08600529 1.64207582 -1.78125 1.1015625 Z " fill="#020202" transform="translate(67.78125,19.8984375)"/>
<path d="M0 0 C4.23233959 1.31000987 8.27487702 2.57433853 12 5 C13.32245649 9.56371645 12.95812913 12.07114519 10.7890625 16.23828125 C10.29043701 17.21595459 9.79181152 18.19362793 9.27807617 19.20092773 C8.73256104 20.22774658 8.1870459 21.25456543 7.625 22.3125 C7.07497314 23.36961182 6.52494629 24.42672363 5.95825195 25.51586914 C4.84097364 27.66036194 3.7180341 29.80191508 2.58935547 31.94042969 C1.15024595 34.71077078 -0.21887569 37.50092994 -1.55859375 40.3203125 C-1.94289551 41.10752686 -2.32719727 41.89474121 -2.72314453 42.70581055 C-3.43138747 44.15674033 -4.12224525 45.61633134 -4.79248047 47.08520508 C-6.50479745 50.48887363 -7.61377951 51.8486242 -11.19921875 53.25390625 C-16.34786623 52.90995755 -19.74610717 50.78769848 -24 48 C-19.35153091 38.07428339 -14.64282577 28.18296773 -9.75 18.375 C-9.15082764 17.1698877 -9.15082764 17.1698877 -8.53955078 15.94042969 C-5.8348967 10.54454968 -2.97052169 5.2539733 0 0 Z " fill="#858585" transform="translate(133,107)"/>
<path d="M0 0 C0.12375 0.61875 0.2475 1.2375 0.375 1.875 C0.87197356 4.19120832 0.87197356 4.19120832 3 6 C3 7.32 3 8.64 3 10 C1.35 10.33 -0.3 10.66 -2 11 C-2.66 10.01 -3.32 9.02 -4 8 C-6.58380177 7.74969023 -6.58380177 7.74969023 -9 8 C-8.67140879 11.72403371 -7.98814038 13.01330592 -5.4375 15.875 C-3 19 -3 19 -2.375 22.5625 C-3.18392498 27.01158742 -4.36049337 28.34619309 -8 31 C-10.76615667 32.13014183 -12.98356104 32.56212983 -16 33 C-19.42416459 30.71722361 -19.145086 30.63338448 -20 27 C-20.515625 26.319375 -21.03125 25.63875 -21.5625 24.9375 C-23 23 -23 23 -23 20 C-20.69 20 -18.38 20 -16 20 C-15.67 20.99 -15.34 21.98 -15 23 C-13.35 23.33 -11.7 23.66 -10 24 C-11.54643374 20.75248914 -13.05562354 17.92738038 -15.25 15.0625 C-17 12 -17 12 -17.0625 8.4375 C-15.7839468 4.30100434 -14.44394159 2.6020892 -11 0 C-7.0093983 -1.1639255 -3.99874158 -1.05849042 0 0 Z " fill="#F9F9F9" transform="translate(53,78)"/>
<path d="M0 0 C5.94 2.475 5.94 2.475 12 5 C11.25 11.625 11.25 11.625 9 15 C8.01 14.67 7.02 14.34 6 14 C6.875 9.25 6.875 9.25 8 7 C7.34 7 6.68 7 6 7 C5.87625 7.804375 5.7525 8.60875 5.625 9.4375 C5.41875 10.283125 5.2125 11.12875 5 12 C4.01 12.495 4.01 12.495 3 13 C2.34 12.67 1.68 12.34 1 12 C1.875 7.25 1.875 7.25 3 5 C2.34 5 1.68 5 1 5 C0.67 6.65 0.34 8.3 0 10 C-1.32 10 -2.64 10 -4 10 C-3.38489368 5.69425578 -2.40932954 4.01554924 0 0 Z " fill="#C4C4C4" transform="translate(84,62)"/>
<path d="M0 0 C6.11570248 1.2231405 6.11570248 1.2231405 8 4 C8.4375 6.4375 8.4375 6.4375 8 9 C6.375 11.3125 6.375 11.3125 4 13 C0.9375 13.4375 0.9375 13.4375 -2 13 C-2.99 12.01 -3.98 11.02 -5 10 C-3.35 6.7 -1.7 3.4 0 0 Z " fill="#BDBDBD" transform="translate(109,71)"/>
<path d="M0 0 C0.99 0.33 1.98 0.66 3 1 C3 1.99 3 2.98 3 4 C3.99 3.34 4.98 2.68 6 2 C6.66 2.33 7.32 2.66 8 3 C8 3.99 8 4.98 8 6 C9.32 5.67 10.64 5.34 12 5 C11.52797514 9.24822374 9.03344482 11.19989709 6 14 C5.4225 13.525625 4.845 13.05125 4.25 12.5625 C1.87849022 10.71876366 1.87849022 10.71876366 -2 10 C-1.34 6.7 -0.68 3.4 0 0 Z " fill="#C6C6C6" transform="translate(135,85)"/>
<path d="M0 0 C2.31 0.66 4.62 1.32 7 2 C7 3.32 7 4.64 7 6 C5.68 6 4.36 6 3 6 C3.66 6.33 4.32 6.66 5 7 C5 7.99 5 8.98 5 10 C3.35 9.67 1.7 9.34 0 9 C-0.33 10.32 -0.66 11.64 -1 13 C-2.32 12.67 -3.64 12.34 -5 12 C-3.68938409 7.76570244 -2.05643741 3.92592596 0 0 Z " fill="#C4C4C4" transform="translate(61,49)"/>
<path d="M0 0 C3 0.125 3 0.125 4 1.125 C4.26293056 5.15660191 4.29404844 6.68392734 2 10.125 C-0.5 10.4375 -0.5 10.4375 -3 10.125 C-3.66 9.465 -4.32 8.805 -5 8.125 C-4.30300807 0.179292 -4.30300807 0.179292 0 0 Z " fill="#C3C3C3" transform="translate(101,69.875)"/>
<path d="M0 0 C2.375 -0.125 2.375 -0.125 5 0 C5.66 0.66 6.32 1.32 7 2 C6.66083005 5.18819752 6.01406317 7.95781049 5 11 C2.07120629 10.37240135 -0.36095629 9.41377341 -3 8 C-2.37240135 5.07120629 -1.41377341 2.63904371 0 0 Z " fill="#C5C5C5" transform="translate(74,59)"/>
<path d="M0 0 C1.99954746 -0.04254356 4.00041636 -0.04080783 6 0 C7 1 7 1 7.1875 3.375 C7 6 7 6 5 9 C3.68 9 2.36 9 1 9 C1.66 10.32 2.32 11.64 3 13 C-0.26954202 12.43628586 -1.82575883 11.50037734 -4 9 C-2.68 9.33 -1.36 9.66 0 10 C-0.37125 9.0925 -0.7425 8.185 -1.125 7.25 C-2 4 -2 4 -1.125 1.625 C-0.75375 1.08875 -0.3825 0.5525 0 0 Z " fill="#848484" transform="translate(124,132)"/>
<path d="M0 0 C1.66611905 -0.042721 3.33382885 -0.04063832 5 0 C5.33 0.33 5.66 0.66 6 1 C5.91062197 2.52519276 5.75462854 4.04681929 5.5625 5.5625 C5.46066406 6.38878906 5.35882813 7.21507813 5.25390625 8.06640625 C5.17011719 8.70449219 5.08632812 9.34257813 5 10 C3.68 10.33 2.36 10.66 1 11 C1 10.34 1 9.68 1 9 C-0.32 9 -1.64 9 -3 9 C-3 7.35 -3 5.7 -3 4 C-2.01 3.67 -1.02 3.34 0 3 C0 2.01 0 1.02 0 0 Z " fill="#C4C4C4" transform="translate(126,82)"/>
<path d="M0 0 C0.99 0.33 1.98 0.66 3 1 C2.27991594 5.60853797 0.68704061 9.67237409 -1 14 C-2.32 13.67 -3.64 13.34 -5 13 C-4.39254603 8.14036821 -2.27241033 4.2594482 0 0 Z " fill="#C3C3C3" transform="translate(71,52)"/>
<path d="M0 0 C2.97 0.495 2.97 0.495 6 1 C6 2.32 6 3.64 6 5 C4.68 5 3.36 5 2 5 C1.67 6.65 1.34 8.3 1 10 C-0.32 9.67 -1.64 9.34 -3 9 C-2.01 6.03 -1.02 3.06 0 0 Z " fill="#C3C3C3" transform="translate(118,78)"/>
<path d="M0 0 C2.97 0.495 2.97 0.495 6 1 C6.38218767 2.65614657 6.71395102 4.32457024 7 6 C6 7 6 7 3.625 7.25 C1 7 1 7 -0.8125 5.5 C-1.204375 5.005 -1.59625 4.51 -2 4 C-1.34 2.68 -0.68 1.36 0 0 Z " fill="#A9A9A9" transform="translate(132,118)"/>
<path d="M0 0 C2.97 0.495 2.97 0.495 6 1 C6.38218767 2.65614657 6.71395102 4.32457024 7 6 C6 7 6 7 3.5625 7.1875 C1 7 1 7 -1 5 C-0.625 2.375 -0.625 2.375 0 0 Z " fill="#A9A9A9" transform="translate(157,86)"/>
<path d="M0 0 C2.9375 0.75 2.9375 0.75 6 2 C6.9375 4 6.9375 4 7 6 C6.67 6.66 6.34 7.32 6 8 C4.68 7.67 3.36 7.34 2 7 C2 6.34 2 5.68 2 5 C0.68 5 -0.64 5 -2 5 C-2 4.34 -2 3.68 -2 3 C-1.01 2.67 -0.02 2.34 1 2 C0.67 1.34 0.34 0.68 0 0 Z " fill="#B5B5B5" transform="translate(115,149)"/>
<path d="M0 0 C1.65 0 3.3 0 5 0 C3.14285714 7.57142857 3.14285714 7.57142857 0 10 C-0.99 9.67 -1.98 9.34 -3 9 C-2.67 8.01 -2.34 7.02 -2 6 C-1.01 6 -0.02 6 1 6 C0.67 4.02 0.34 2.04 0 0 Z " fill="#61615F" transform="translate(152,117)"/>
<path d="M0 0 C4.75 0.75 4.75 0.75 7 3 C6.625 5.125 6.625 5.125 6 7 C3.7106677 5.85533385 2.84607449 4.84607449 1 3 C0.01 3 -0.98 3 -2 3 C-1.34 2.01 -0.68 1.02 0 0 Z " fill="#BCBCBC" transform="translate(118,144)"/>
<path d="M0 0 C2.02045442 0.60183749 4.02111039 1.27306096 6 2 C6.33 2.66 6.66 3.32 7 4 C5.68 4 4.36 4 3 4 C3.66 5.32 4.32 6.64 5 8 C1.73045798 7.43628586 0.17424117 6.50037734 -2 4 C-0.68 4.33 0.64 4.66 2 5 C1.34 3.35 0.68 1.7 0 0 Z " fill="#C0C0C0" transform="translate(122,137)"/>
<path d="M0 0 C2.97 0.33 5.94 0.66 9 1 C9 1.66 9 2.32 9 3 C7.35 3 5.7 3 4 3 C4.66 4.32 5.32 5.64 6 7 C3.95880212 5.38405168 1.95927063 3.7143618 0 2 C0 1.34 0 0.68 0 0 Z " fill="#B9B9B9" transform="translate(134,113)"/>
<path d="M0 0 C2.69082872 0.17635452 5.32851446 0.61835921 8 1 C8 1.66 8 2.32 8 3 C6.35 3 4.7 3 3 3 C3.99 4.32 4.98 5.64 6 7 C2.63279613 5.60667426 1.0140476 4.0210714 -1 1 C-0.67 0.67 -0.34 0.34 0 0 Z " fill="#BBBBBB" transform="translate(160,81)"/>
<path d="M0 0 C0.99 0 1.98 0 3 0 C3 1.32 3 2.64 3 4 C3.99 4 4.98 4 6 4 C5.67 4.99 5.34 5.98 5 7 C3.35 6.67 1.7 6.34 0 6 C0 4.02 0 2.04 0 0 Z " fill="#676767" transform="translate(147,129)"/>
<path d="M0 0 C1.99954746 -0.04254356 4.00041636 -0.04080783 6 0 C7 1 7 1 7.0625 3.5625 C7.041875 4.366875 7.02125 5.17125 7 6 C6.01 6.495 6.01 6.495 5 7 C4.67 5.35 4.34 3.7 4 2 C3.01 1.67 2.02 1.34 1 1 C1 1.99 1 2.98 1 4 C0.34 3.67 -0.32 3.34 -1 3 C-0.67 2.01 -0.34 1.02 0 0 Z " fill="#BDBDBD" transform="translate(124,132)"/>
<path d="M0 0 C2.125 0.375 2.125 0.375 4 1 C3.01 1 2.02 1 1 1 C0.896875 1.61875 0.79375 2.2375 0.6875 2.875 C0 5 0 5 -3 7 C-2.25 2.25 -2.25 2.25 0 0 Z " fill="#878787" transform="translate(73,58)"/>
<path d="M0 0 C0.99 0.33 1.98 0.66 3 1 C2.67 3.31 2.34 5.62 2 8 C1.01 7.67 0.02 7.34 -1 7 C-0.67 4.69 -0.34 2.38 0 0 Z " fill="#929292" transform="translate(132,84)"/>
<text x="110" y="128" fill="#FFFFFF" font-family="Urbanist" font-weight="900" font-size="24" text-anchor="middle" dominant-baseline="middle" alignment-baseline="central" transform="rotate(24 120 126)">${amount}</text>
</g>
</svg>`;
}

export default function CartModal({ isOpen, onClose, totalPrice: _totalPrice = 1.38, items }: CartModalProps) {
  const [activeTab, setActiveTab] = useState<'all' | 'selected'>('all');
  const [selectedItems, setSelectedItems] = useState<Set<string>>(new Set());
  const [sortByPrice, setSortByPrice] = useState<'asc' | 'desc'>('desc');

  // ä½¿ç”¨è´­ç‰©è½¦ hook è·å–æ•°æ®
  const { cartItems, isLoading: warehouseLoading, refetch: refetchCart } = useCart();
  const { fetchUserBean } = useAuth();
  const [viewMode, setViewMode] = useState<'cart' | 'shop'>('cart');
  const isShopMode = viewMode === 'shop';
  const [shopItems, setShopItems] = useState<CartItem[]>([]);
  const [isShopLoading, setIsShopLoading] = useState(false);
  const [buyingProductId, setBuyingProductId] = useState<string | null>(null);

  // å°†è´­ç‰©è½¦æ•°æ®è½¬æ¢ä¸º CartItem æ ¼å¼ï¼ˆå¦‚æœå¤–éƒ¨æœªä¼ å…¥ items åˆ™ä½¿ç”¨è´­ç‰©è½¦æ•°æ®ï¼‰
  const expandedWarehouseItems: CartItem[] = cartItems.map((item, index) => ({
    ...item,
    id: item.id || `cart_${index}`,
  }));

  const hasExternalItems = Array.isArray(items) && items.length > 0;
  const shouldShowWarehouseLoading = warehouseLoading && !hasExternalItems;
  const defaultItems: CartItem[] = useMemo(
    () => {
      const baseItems = hasExternalItems ? (items as CartItem[]) : expandedWarehouseItems;
      return baseItems.map((item, index) => {
        const baseId =
          item.warehouseId ??
          (typeof item.id === 'string' && item.id.includes('#') ? item.id.split('#')[0] : item.id) ??
          `cart_${index}`;
        return {
          ...item,
          warehouseId: baseId,
        };
      });
    },
    [hasExternalItems, items, expandedWarehouseItems],
  );

  const mapShopItems = (payload: any): CartItem[] => {
    const rows = Array.isArray(payload?.data?.data)
      ? payload.data.data
      : Array.isArray(payload?.data)
        ? payload.data
        : Array.isArray(payload)
          ? payload
          : [];
    return rows.map((item: any, index: number) => {
      const baseId = String(item.id ?? item.box_id ?? `shop_${index}`);
      return {
        id: baseId,
        warehouseId: baseId,
        productId: String(item.product_id ?? item.id ?? baseId),
        name: item.name ?? item.title ?? item.awards?.name ?? `å•†å“ ${index + 1}`,
        price: Number(item.bean ?? item.price ?? item.amount ?? item.awards?.bean ?? 0),
        image: item.cover ?? item.image ?? item.icon ?? item.awards?.cover ?? '',
      };
    });
  };

  const handleOpenCart = () => {
    setViewMode('cart');
    setShopItems([]);
    setActiveTab('all');
    setSelectedItems(new Set());
    setSelectionOrder([]);
    refetchCart();
  };

  const handleOpenShop = async () => {
    if (isShopLoading) return;
    setViewMode('shop');
    setActiveTab('all');
    setSelectedItems(new Set());
    setSelectionOrder([]);
    setIsShopLoading(true);
    try {
      const response = await api.getShopList();
      if (response.code === 100000) {
        setShopItems(mapShopItems(response));
      } else {
        throw new Error(response.message || 'è·å–å•†åŸå¤±è´¥');
      }
    } catch (error: any) {
      showGlobalToast({
        title: 'é”™è¯¯',
        description: error?.message || 'è·å–å•†åŸå¤±è´¥',
        variant: 'error',
      });
      setShopItems([]);
    } finally {
      setIsShopLoading(false);
    }
  };

  const handleToggleMode = () => {
    if (isShopMode) {
      handleOpenCart();
    } else {
      handleOpenShop();
    }
  };

  useEffect(() => {
    if (isOpen) {
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = '';
    }
    return () => {
      document.body.style.overflow = '';
    };
  }, [isOpen]);

  useEffect(() => {
    if (!isOpen) return;
    const handleEscape = (e: KeyboardEvent) => {
      if (e.key === 'Escape') onClose();
    };
    window.addEventListener('keydown', handleEscape);
    return () => window.removeEventListener('keydown', handleEscape);
  }, [isOpen, onClose]);

  useEffect(() => {
    if (isOpen) {
      refetchCart();
    } else {
      setViewMode('cart');
      setShopItems([]);
      setActiveTab('all');
      setSelectedItems(new Set());
      setSelectionOrder([]);
    }
  }, [isOpen, refetchCart]);

  const [selectionOrder, setSelectionOrder] = useState([] as string[]);
  const [claimableActive, setClaimableActive] = useState(false);
  const queryClient = useQueryClient();
  const listSourceItems = isShopMode ? shopItems : defaultItems;
  const displayedItems = activeTab === 'all' ? listSourceItems : listSourceItems.filter(item => selectedItems.has(item.id));
  const selectedCount = isShopMode ? 0 : selectedItems.size;
  const selectedTotal = isShopMode
    ? 0
    : defaultItems
        .filter(item => selectedItems.has(item.id))
        .reduce((sum, item) => sum + item.price, 0);
  const cartTotal = defaultItems.reduce((sum, item) => sum + item.price, 0);
  const listLoading = isShopMode ? isShopLoading : shouldShowWarehouseLoading;
  const listLoadingText = isShopMode ? 'å•†åŸåŠ è½½ä¸­...' : 'æ­£åœ¨åŠ è½½ä»“åº“...';
  const emptyListText = isShopMode ? 'å•†åŸæš‚æ— æ•°æ®' : 'ä»“åº“æš‚æ— ç‰©å“';
  const actionButtonLabel = isShopMode ? 'è´­ç‰©è½¦' : 'å•†åŸ';
  const actionButtonDisabled = isShopLoading;

  function getDepthFromProductId(productId: string): number {
    if (!productId?.startsWith('voucher:')) return 0;
    const parts = productId.split(':');
    const depthStr = parts[parts.length - 1];
    const d = Number(depthStr);
    return Number.isFinite(d) ? d : 1;
  }

  function getSourceProductId(productId: string): string {
    if (!productId?.startsWith('voucher:')) return productId;
    const parts = productId.split(':');
    return parts[1] ?? productId;
  }

  function toCents(v: number) { return Math.round(v * 100); }
  function fromCents(c: number) { return Math.max(0.01, Math.round(c) / 100); }

  // âœ… æš‚æ—¶ç¦ç”¨åˆ†å‰²åŠŸèƒ½ï¼Œç­‰å¾…åç»­å®ç°ä»“åº“æ¥å£
  const splitMutation = useMutation({
    mutationFn: async (item: CartItem) => {
      throw new Error('ä»“åº“åŠŸèƒ½æš‚æœªå¼€æ”¾');
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['warehouse'] });
      queryClient.invalidateQueries({ queryKey: ['user'] });
    },
  });

  const buyShopItemMutation = useMutation({
    mutationFn: async (productId: string) => {
      if (!productId) {
        throw new Error('å•†å“ ID æ— æ•ˆ');
      }
      const response = await api.buyShopItem(productId);
      if (response.code !== 100000) {
        throw new Error(response.message || 'è´­ä¹°å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
      }
      return response;
    },
    onSuccess: () => {
      showGlobalToast({
        title: 'è´­ä¹°æˆåŠŸ',
        description: 'ä½™é¢å·²æ›´æ–°',
        variant: 'success',
      });
      fetchUserBean().catch(() => {});
    },
    onError: (error: any) => {
      showGlobalToast({
        title: 'è´­ä¹°å¤±è´¥',
        description: error?.message || 'è¯·ç¨åé‡è¯•',
        variant: 'error',
      });
    },
  });

  // ç¡®è®¤å‡ºå”®å¼¹çª—çŠ¶æ€
  const [confirmOpen, setConfirmOpen] = useState(false);
  const [confirmCount, setConfirmCount] = useState(0);
  const [confirmGain, setConfirmGain] = useState(0);
  const [confirmPayload, setConfirmPayload] = useState<string[]>([]);

  const itemMap = useMemo(() => {
    const map = new Map<string, CartItem>();
    defaultItems.forEach((item) => {
      map.set(item.id, item);
    });
    return map;
  }, [defaultItems]);

  // âœ… æš‚æ—¶ç¦ç”¨å‡ºå”®åŠŸèƒ½ï¼Œç­‰å¾…åç»­å®ç°ä»“åº“æ¥å£
  const confirmSellMutation = useMutation({
    mutationFn: async (ids: string[]) => {
      if (!ids.length) {
        throw new Error('è¯·é€‰æ‹©è¦å‡ºå”®çš„ç‰©å“');
      }
      return api.cashOutBoxes(ids);
    },
    onSuccess: () => {
      setSelectedItems(new Set());
      setSelectionOrder([]);
      queryClient.invalidateQueries({ queryKey: ['userStorage'] });
      queryClient.invalidateQueries({ queryKey: ['user'] });
      showGlobalToast({
        title: 'å‡ºå”®æˆåŠŸ',
        description: 'ä½™é¢å·²æ›´æ–°',
        variant: 'success',
      });
      fetchUserBean().catch(() => {});
      setConfirmOpen(false);
    },
  });

  const buildSelectedSellIds = (): string[] => {
    const ids: string[] = [];
    for (const uniqueId of selectedItems) {
      const item = itemMap.get(uniqueId);
      if (!item?.warehouseId) continue;
      ids.push(item.warehouseId);
    }
    return ids;
  };

  const openConfirmForSelected = () => {
    if (selectedCount === 0) return;
    const payload = buildSelectedSellIds();
    setConfirmPayload(payload);
    setConfirmCount(payload.length);
    setConfirmGain(selectedTotal);
    setConfirmOpen(true);
  };

  const openConfirmForSingle = (item: CartItem) => {
    const warehouseId =
      item.warehouseId ?? (typeof item.id === 'string' && item.id.includes('#') ? item.id.split('#')[0] : item.id);
    setConfirmPayload([warehouseId]);
    setConfirmCount(1);
    setConfirmGain(item.price);
    setConfirmOpen(true);
  };

  const handleBuyShopItem = (item: CartItem) => {
    if (!item?.productId) {
      showGlobalToast({
        title: 'é”™è¯¯',
        description: 'å•†å“ä¿¡æ¯ç¼ºå¤±ï¼Œæ— æ³•è´­ä¹°',
        variant: 'error',
      });
      return;
    }
    if (buyShopItemMutation.isPending) return;
    setBuyingProductId(item.productId);
    buyShopItemMutation.mutate(item.productId, {
      onSettled: () => setBuyingProductId(null),
    });
  };

  if (!isOpen) return null;

  const toggleSelect = (id: string) => {
    if (isShopMode) return;
    const newSelected = new Set(selectedItems);
    if (newSelected.has(id)) {
      newSelected.delete(id);
      setSelectionOrder((prev) => prev.filter((x) => x !== id));
    } else {
      newSelected.add(id);
      setSelectionOrder((prev) => prev.includes(id) ? prev : [...prev, id]);
    }
    setSelectedItems(new Set(newSelected));
  };

  const selectAll = () => {
    if (isShopMode) return;
    if (selectedItems.size === defaultItems.length) {
      setSelectedItems(new Set());
      setSelectionOrder([]);
    } else {
      const allIds = defaultItems.map(item => item.id);
      setSelectedItems(new Set(allIds));
      setSelectionOrder(allIds);
    }
  };

  const sortedItems = [...displayedItems].sort((a, b) => {
    return sortByPrice === 'asc' ? a.price - b.price : b.price - a.price;
  });

  return (
    <div
      data-state={isOpen ? 'open' : 'closed'}
      className="fixed inset-0 z-50 bg-black/[0.48] data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 flex justify-center items-start sm:items-start sm:py-16 sm:px-4 p-4"
      style={{ pointerEvents: 'auto', overflowY: 'auto', WebkitOverflowScrolling: 'touch' }}
      onClick={onClose}
    >
      <div
        role="dialog"
        aria-describedby="cart-description"
        aria-labelledby="cart-title"
        data-state={isOpen ? 'open' : 'closed'}
        className="z-50 max-w-lg w-full gap-4 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 sm:rounded-lg relative sm:max-w-4xl p-0 flex flex-col"
        tabIndex={-1}
        style={{ 
          pointerEvents: 'auto', 
          backgroundColor: '#161A1D',
        }}
        onClick={(e) => e.stopPropagation()}
      >
        {/* å¤´éƒ¨ */}
        <div className="flex-col gap-1.5 text-center sm:text-left p-4 pt-6 sm:pt-4 h-16 flex justify-center flex-shrink-0" style={{ borderBottom: '1px solid #2E3134' }}>
          <div className="flex items-center">
            <h2 id="cart-title" className="tracking-tight text-left text-base font-extrabold pr-3" style={{ color: '#FEFEFE' }}>
              {isShopMode ? 'å•†åŸ' : 'æ‚¨çš„è´­ç‰©è½¦'}
            </h2>
            {!isShopMode && (
              <p className="flex gap-2 items-center pl-3" style={{ borderLeft: '1px solid #2E3134' }}>
                <span className="font-extrabold" style={{ color: '#FEFEFE' }}>${cartTotal.toFixed(2)}</span>
              </p>
            )}
          </div>
        </div>

        {/* ç§»åŠ¨ç«¯æ ‡ç­¾é¡µ */}
        <div dir="ltr" data-orientation="horizontal" className="w-full sm:hidden flex flex-col px-4 sm:px-6 flex-1 min-h-0 pt-4">
          <div role="tablist" aria-orientation="horizontal" className="inline-flex items-center justify-center rounded-md p-1 w-full h-10 sm:h-12 text-sm sm:text-base flex-shrink-0" tabIndex={0} data-orientation="horizontal" style={{ outline: 'none', backgroundColor: '#22272B' }}>
            <button
              type="button"
              role="tab"
              aria-selected={activeTab === 'all'}
              aria-controls="cart-content-all"
              data-state={activeTab === 'all' ? 'active' : 'inactive'}
              id="cart-trigger-all"
              className="inline-flex items-center justify-center whitespace-nowrap rounded-md px-3 py-1 h-full transition-all interactive-focus disabled:pointer-events-none disabled:opacity-50 text-base font-regular text-white flex-1"
              tabIndex={-1}
              data-orientation="horizontal"
              onClick={() => setActiveTab('all')}
              style={{ backgroundColor: activeTab === 'all' ? '#34383C' : 'transparent' }}
            >
              <span className="font-extrabold" style={{ color: '#FFFFFF' }}>æ‰€æœ‰ç‰©å“ ({defaultItems.length})</span>
            </button>
            {!isShopMode && (
              <button
                type="button"
                role="tab"
                aria-selected={activeTab === 'selected'}
                aria-controls="cart-content-selected"
                data-state={activeTab === 'selected' ? 'active' : 'inactive'}
                id="cart-trigger-selected"
                className="inline-flex items-center justify-center whitespace-nowrap rounded-md px-3 py-1 h-full transition-all interactive-focus disabled:pointer-events-none disabled:opacity-50 text-base font-regular flex-1"
                tabIndex={-1}
                data-orientation="horizontal"
                onClick={() => setActiveTab('selected')}
                style={{ backgroundColor: activeTab === 'selected' ? '#34383C' : 'transparent' }}
              >
                <span className="font-extrabold" style={{ color: '#FFFFFF' }}>å·²é€‰æ‹©çš„ç‰©å“ ({selectedCount})</span>
              </button>
            )}
          </div>

          {/* ç§»åŠ¨ç«¯å†…å®¹ */}
          <div
            data-state={activeTab === 'all' ? 'active' : 'inactive'}
            data-orientation="horizontal"
            role="tabpanel"
            aria-labelledby="cart-trigger-all"
            id="cart-content-all"
            tabIndex={0}
            className="flex-1 flex flex-col min-h-0"
            style={{ display: activeTab === 'all' ? 'flex' : 'none' }}
          >
            <div className="flex justify-between my-3 gap-2 w-full flex-nowrap flex-shrink-0">
              <div className="gap-2 shrink-0 hidden sm:flex">
                {!isShopMode && (
                  <button
                    className="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md transition-colors disabled:pointer-events-none interactive-focus relative h-9 px-3 font-semibold text-sm sm:h-10"
                    style={{ backgroundColor: '#161A1D', color: '#FFFFFF', border: '1px solid #45484A' }}
                    type="button"
                  >
                    å¯è®¤é¢†ç‰©å“
                  </button>
                )}
              </div>
              <div className="flex gap-2 shrink-0 w-full sm:w-auto justify-between">
                <button
                  className="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md transition-colors disabled:pointer-events-none interactive-focus relative h-9 px-3 font-semibold text-sm sm:h-10"
                  style={{ backgroundColor: '#22272B', color: '#FFFFFF' }}
                  onClick={() => setSortByPrice(sortByPrice === 'asc' ? 'desc' : 'asc')}
                  type="button"
                >
                  ä»·æ ¼
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-arrow-down">
                    <path d="M12 5v14"></path>
                    <path d="m19 12-7 7-7-7"></path>
                  </svg>
                </button>
                {!isShopMode && (
                  <button
                    className="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md transition-colors disabled:pointer-events-none interactive-focus relative h-9 px-3 font-semibold text-sm group sm:h-10"
                    style={{ backgroundColor: '#22272B', color: '#FFFFFF' }}
                    onClick={selectAll}
                    type="button"
                  >
                    <div
                      className="size-5 shrink-0 rounded border flex items-center justify-center transition-all"
                      style={{
                        backgroundColor: (selectedItems.size === defaultItems.length && defaultItems.length > 0) ? '#4299E1' : '#22272B',
                        borderColor: '#5A5E62',
                        borderWidth: 1,
                      }}
                    >
                      {(selectedItems.size === defaultItems.length && defaultItems.length > 0) && (
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#FFFFFF" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round">
                          <path d="M20 6L9 17l-5-5"></path>
                        </svg>
                      )}
                    </div>
                    {(selectedItems.size === defaultItems.length && defaultItems.length > 0) ? 'å–æ¶ˆå…¨é€‰' : `å…¨é€‰ (${defaultItems.length})`}
                  </button>
                )}
              </div>
            </div>
            <div className="flex-1 overflow-y-auto min-h-0" style={{ maxHeight: 'calc(100vh - 320px)' }}>
              {listLoading ? (
                <div className="flex h-full items-center justify-center font-semibold" style={{ color: '#7A8084' }}>{listLoadingText}</div>
              ) : displayedItems.length > 0 ? (
                <div className="grid grid-cols-2 xs:grid-cols-3 gap-4 pb-4">
                  {sortedItems?.length>0&&sortedItems.map((item) => (
                    <CartItemCard
                      key={item.id}
                      item={item}
                      isShopMode={isShopMode}
                      isSelected={!isShopMode && selectedItems.has(item.id)}
                      onToggleSelect={() => toggleSelect(item.id)}
                      onSplit={splitMutation.mutate}
                      onSell={(it) => openConfirmForSingle(it)}
                    />
                  ))}
                </div>
              ) : (
                <div className="flex items-center justify-center w-full text-center font-semibold" style={{ color: '#7A8084', minHeight: '120px' }}>
                  {emptyListText}
                </div>
              )}
            </div>
            <div className="flex justify-between mt-2 mb-6 rounded-lg flex-col sm:flex-row items-center flex-shrink-0 pt-2 pb-4" style={{ backgroundColor: '#161A1D' }}>
              <div className="hidden sm:block">
                <div className="flex gap-1 items-center">
                  {selectedCount > 0 && (
                    <button
                      className="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors disabled:pointer-events-none interactive-focus relative bg-transparent text-base font-bold select-none size-6 min-h-6 min-w-6 max-h-6 max-w-6 rounded-[4px]"
                      type="button"
                      onClick={() => { setSelectedItems(new Set()); setSelectionOrder([]); }}
                      style={{ cursor: 'pointer', color: '#FFFFFF' }}
                    >
                      <div className="size-5">
                        <svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path fillRule="evenodd" clipRule="evenodd" d="M3.29289 3.29289C3.68342 2.90237 4.31658 2.90237 4.70711 3.29289L8 6.58579L11.2929 3.29289C11.6834 2.90237 12.3166 2.90237 12.7071 3.29289C13.0976 3.68342 13.0976 4.31658 12.7071 4.70711L9.41421 8L12.7071 11.2929C13.0976 11.6834 13.0976 12.3166 12.7071 12.7071C12.3166 13.0976 11.6834 13.0976 11.2929 12.7071L8 9.41421L4.70711 12.7071C4.31658 13.0976 3.68342 13.0976 3.29289 12.7071C2.90237 12.3166 2.90237 11.6834 3.29289 11.2929L6.58579 8L3.29289 4.70711C2.90237 4.31658 2.90237 3.68342 3.29289 3.29289Z" fill="currentColor"></path>
                        </svg>
                      </div>
                    </button>
                  )}
                  <p className="font-extrabold" style={{ color: selectedCount > 0 ? '#FFFFFF' : '#7A8084' }}>å·²é€‰æ‹© {selectedCount} ä¸ª ${selectedTotal.toFixed(2)}</p>
                </div>
              </div>
              <div className="flex gap-3 w-full sm:w-auto">
                <button
                  className="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md transition-colors interactive-focus relative select-none h-10 px-4 w-full sm:min-w-28 font-bold"
                  style={{ backgroundColor: selectedCount === 0 ? '#34383C' : '#4299E1', color: selectedCount === 0 ? '#2B6CB0' : '#FFFFFF', cursor: selectedCount === 0 ? 'default' : 'pointer' }}
                  disabled={selectedCount === 0}
                  onMouseEnter={(e) => { if (selectedCount > 0) (e.currentTarget as HTMLButtonElement).style.opacity = '0.9'; }}
                  onMouseLeave={(e) => { if (selectedCount > 0) (e.currentTarget as HTMLButtonElement).style.opacity = '1'; }}
                onClick={() => { if (selectedCount > 0) openConfirmForSelected(); }}
                >
                  å‡ºå”®
                </button>
                <button
                  className="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md transition-colors interactive-focus relative select-none h-10 px-4 w-full sm:sm:min-w-28 font-bold"
                  style={{ backgroundColor: '#34383C', color: selectedCount === 0 ? '#7A8084' : '#FFFFFF', cursor: selectedCount === 0 ? 'default' : 'pointer' }}
                  disabled={selectedCount === 0}
                  onMouseEnter={(e) => { if (selectedCount > 0) (e.currentTarget as HTMLButtonElement).style.backgroundColor = '#5A5E62'; }}
                  onMouseLeave={(e) => { if (selectedCount > 0) (e.currentTarget as HTMLButtonElement).style.backgroundColor = '#34383C'; }}
                >
                  ææ¬¾
                </button>
                <button
                  className="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md transition-colors interactive-focus relative select-none h-10 px-4 w-full sm:sm:min-w-28 font-bold"
                  style={{ backgroundColor: '#34383C', color: actionButtonDisabled ? '#7A8084' : '#FFFFFF', cursor: actionButtonDisabled ? 'default' : 'pointer' }}
                  disabled={actionButtonDisabled}
                  onMouseEnter={(e) => { if (!actionButtonDisabled) (e.currentTarget as HTMLButtonElement).style.backgroundColor = '#5A5E62'; }}
                  onMouseLeave={(e) => { if (!actionButtonDisabled) (e.currentTarget as HTMLButtonElement).style.backgroundColor = '#34383C'; }}
                  onClick={handleToggleMode}
                >
                  {actionButtonLabel}
                </button>
              </div>
            </div>
          </div>
          <div
            data-state={activeTab === 'selected' ? 'active' : 'inactive'}
            data-orientation="horizontal"
            role="tabpanel"
            aria-labelledby="cart-trigger-selected"
            id="cart-content-selected"
            tabIndex={0}
            className="flex-1 flex flex-col min-h-0"
            style={{ display: activeTab === 'selected' ? 'flex' : 'none' }}
          >
            {/* å·²é€‰æ‹©æ•°é‡æ˜¾ç¤º */}
            <div className="flex gap-1 items-center flex-shrink-0 my-3">
              {selectedCount > 0 ? (
                <div className="flex gap-1 items-center">
                  <button
                    className="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors disabled:pointer-events-none interactive-focus relative bg-transparent text-base font-bold select-none size-6 min-h-6 min-w-6 max-h-6 max-w-6 rounded-[4px]"
                    type="button"
                    onClick={() => { setSelectedItems(new Set()); setSelectionOrder([]); }}
                    style={{ cursor: 'pointer', color: '#FFFFFF' }}
                    onMouseEnter={(e) => { (e.currentTarget as HTMLButtonElement).style.color = '#FFFFFF'; }}
                    onMouseLeave={(e) => { (e.currentTarget as HTMLButtonElement).style.color = '#FFFFFF'; }}
                  >
                    <div className="size-5 text-white">
                      <svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fillRule="evenodd" clipRule="evenodd" d="M3.29289 3.29289C3.68342 2.90237 4.31658 2.90237 4.70711 3.29289L8 6.58579L11.2929 3.29289C11.6834 2.90237 12.3166 2.90237 12.7071 3.29289C13.0976 3.68342 13.0976 4.31658 12.7071 4.70711L9.41421 8L12.7071 11.2929C13.0976 11.6834 13.0976 12.3166 12.7071 12.7071C12.3166 13.0976 11.6834 13.0976 11.2929 12.7071L8 9.41421L4.70711 12.7071C4.31658 13.0976 3.68342 13.0976 3.29289 12.7071C2.90237 12.3166 2.90237 11.6834 3.29289 11.2929L6.58579 8L3.29289 4.70711C2.90237 4.31658 2.90237 3.68342 3.29289 3.29289Z" fill="currentColor"></path>
                      </svg>
                    </div>
                  </button>
                  <p className="font-extrabold" style={{ color: '#FFFFFF' }}>å·²é€‰æ‹© {selectedCount} ä¸ª ${selectedTotal.toFixed(2)}</p>
                </div>
              ) : (
                <p className="font-extrabold" style={{ color: '#7A8084' }}>å·²é€‰æ‹© {selectedCount} ä¸ª ${selectedTotal.toFixed(2)}</p>
              )}
            </div>
            
            {/* ç‰©å“åŒºåŸŸ */}
            <div className="flex-1 overflow-y-auto min-h-0 rounded-lg" style={{ backgroundColor: '#1D2125', maxHeight: 'calc(100vh - 320px)' }}>
              {selectedCount === 0 ? (
                <div className="flex h-full items-center justify-center font-semibold" style={{ color: '#7A8084' }}>è¯·é€‰æ‹©ç‰©å“æ¥ç®¡ç†ä»–ä»¬</div>
              ) : (
                <div className="grid grid-cols-2 xs:grid-cols-3 gap-4 p-4">
                  {selectionOrder.filter((id) => selectedItems.has(id)).map((id) => {
                    const it = defaultItems.find((d) => d.id === id);
                    if (!it) return null;
                    return (
                      <SelectedCartItemCard
                        key={it.id}
                        item={it}
                        onRemove={() => toggleSelect(it.id)}
                      />
                    );
                  })}
                </div>
              )}
            </div>
            
            {/* æŒ‰é’®åŒºåŸŸ */}
            <div className="flex justify-between mt-2 mb-6 rounded-lg flex-col sm:flex-row items-center flex-shrink-0 pt-2 pb-4" style={{ backgroundColor: '#161A1D' }}>
              <div className="hidden sm:block">
                <div className="flex gap-1 items-center">
                  {selectedCount > 0 && (
                    <button
                      className="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors disabled:pointer-events-none interactive-focus relative bg-transparent text-base font-bold select-none size-6 min-h-6 min-w-6 max-h-6 max-w-6 rounded-[4px]"
                      type="button"
                      onClick={() => { setSelectedItems(new Set()); setSelectionOrder([]); }}
                      style={{ cursor: 'pointer', color: '#FFFFFF' }}
                    >
                      <div className="size-5">
                        <svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path fillRule="evenodd" clipRule="evenodd" d="M3.29289 3.29289C3.68342 2.90237 4.31658 2.90237 4.70711 3.29289L8 6.58579L11.2929 3.29289C11.6834 2.90237 12.3166 2.90237 12.7071 3.29289C13.0976 3.68342 13.0976 4.31658 12.7071 4.70711L9.41421 8L12.7071 11.2929C13.0976 11.6834 13.0976 12.3166 12.7071 12.7071C12.3166 13.0976 11.6834 13.0976 11.2929 12.7071L8 9.41421L4.70711 12.7071C4.31658 13.0976 3.68342 13.0976 3.29289 12.7071C2.90237 12.3166 2.90237 11.6834 3.29289 11.2929L6.58579 8L3.29289 4.70711C2.90237 4.31658 2.90237 3.68342 3.29289 3.29289Z" fill="currentColor"></path>
                        </svg>
                      </div>
                    </button>
                  )}
                  <p className="font-extrabold" style={{ color: selectedCount > 0 ? '#FFFFFF' : '#7A8084' }}>å·²é€‰æ‹© {selectedCount} ä¸ª ${selectedTotal.toFixed(2)}</p>
                </div>
              </div>
              <div className="flex gap-3 w-full sm:w-auto">
                <button
                  className="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md transition-colors interactive-focus relative select-none h-10 px-4 w-full sm:min-w-28 font-bold"
                  style={{ backgroundColor: selectedCount === 0 ? '#34383C' : '#4299E1', color: selectedCount === 0 ? '#2B6CB0' : '#FFFFFF', cursor: selectedCount === 0 ? 'default' : 'pointer' }}
                  disabled={selectedCount === 0}
                  onMouseEnter={(e) => { if (selectedCount > 0) (e.currentTarget as HTMLButtonElement).style.opacity = '0.9'; }}
                  onMouseLeave={(e) => { if (selectedCount > 0) (e.currentTarget as HTMLButtonElement).style.opacity = '1'; }}
                  onClick={() => { if (selectedCount > 0) openConfirmForSelected(); }}
                >
                  å‡ºå”®
                </button>
                <button
                  className="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md transition-colors interactive-focus relative select-none h-10 px-4 w-full sm:sm:min-w-28 font-bold"
                  style={{ backgroundColor: '#34383C', color: selectedCount === 0 ? '#7A8084' : '#FFFFFF', cursor: selectedCount === 0 ? 'default' : 'pointer' }}
                  disabled={selectedCount === 0}
                  onMouseEnter={(e) => { if (selectedCount > 0) (e.currentTarget as HTMLButtonElement).style.backgroundColor = '#5A5E62'; }}
                  onMouseLeave={(e) => { if (selectedCount > 0) (e.currentTarget as HTMLButtonElement).style.backgroundColor = '#34383C'; }}
                >
                  ææ¬¾
                </button>
                <button
                  className="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md transition-colors interactive-focus relative select-none h-10 px-4 w-full sm:sm:min-w-28 font-bold"
                  style={{ backgroundColor: '#34383C', color: actionButtonDisabled ? '#7A8084' : '#FFFFFF', cursor: actionButtonDisabled ? 'default' : 'pointer' }}
                  disabled={actionButtonDisabled}
                  onMouseEnter={(e) => { if (!actionButtonDisabled) (e.currentTarget as HTMLButtonElement).style.backgroundColor = '#5A5E62'; }}
                  onMouseLeave={(e) => { if (!actionButtonDisabled) (e.currentTarget as HTMLButtonElement).style.backgroundColor = '#34383C'; }}
                  onClick={handleToggleMode}
                >
                  {actionButtonLabel}
                </button>
              </div>
            </div>
          </div>
        </div>

        {/* æ¡Œé¢ç«¯å†…å®¹ */}
        <div className="hidden sm:block pb-4 px-4 sm:px-6 flex-1 min-h-0 flex flex-col">
          <div className="flex justify-between mt-2 mb-4 rounded-lg flex-col sm:flex-row items-center">
            <div className="hidden sm:block">
              <div className="flex gap-1 items-center">
                {selectedCount > 0 && (
                  <button
                    className="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors disabled:pointer-events-none interactive-focus relative bg-transparent text-base font-bold select-none size-6 min-h-6 min-w-6 max-h-6 max-w-6 rounded-[4px]"
                    type="button"
                    onClick={() => { setSelectedItems(new Set()); setSelectionOrder([]); }}
                    style={{ cursor: 'pointer', color: '#FFFFFF' }}
                  >
                    <div className="size-5">
                      <svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fillRule="evenodd" clipRule="evenodd" d="M3.29289 3.29289C3.68342 2.90237 4.31658 2.90237 4.70711 3.29289L8 6.58579L11.2929 3.29289C11.6834 2.90237 12.3166 2.90237 12.7071 3.29289C13.0976 3.68342 13.0976 4.31658 12.7071 4.70711L9.41421 8L12.7071 11.2929C13.0976 11.6834 13.0976 12.3166 12.7071 12.7071C12.3166 13.0976 11.6834 13.0976 11.2929 12.7071L8 9.41421L4.70711 12.7071C4.31658 13.0976 3.68342 13.0976 3.29289 12.7071C2.90237 12.3166 2.90237 11.6834 3.29289 11.2929L6.58579 8L3.29289 4.70711C2.90237 4.31658 2.90237 3.68342 3.29289 3.29289Z" fill="currentColor"></path>
                      </svg>
                    </div>
                  </button>
                )}
                <p className="font-extrabold" style={{ color: selectedCount > 0 ? '#FFFFFF' : '#7A8084' }}>å·²é€‰æ‹© {selectedCount} ä¸ª ${selectedTotal.toFixed(2)}</p>
              </div>
            </div>
            <div className="flex gap-3 w-full sm:w-auto">
              <button
                className="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md transition-colors interactive-focus relative select-none h-10 px-4 w-full sm:min-w-28 font-bold"
                style={{ backgroundColor: selectedCount === 0 ? '#34383C' : '#4299E1', color: selectedCount === 0 ? '#2B6CB0' : '#FFFFFF', cursor: selectedCount === 0 ? 'default' : 'pointer' }}
                disabled={selectedCount === 0}
                onMouseEnter={(e) => { if (selectedCount > 0) (e.currentTarget as HTMLButtonElement).style.opacity = '0.9'; }}
                onMouseLeave={(e) => { if (selectedCount > 0) (e.currentTarget as HTMLButtonElement).style.opacity = '1'; }}
                onClick={() => { if (selectedCount > 0) openConfirmForSelected(); }}
              >
                å‡ºå”®
              </button>
              <button
                className="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md transition-colors interactive-focus relative select-none h-10 px-4 w-full sm:sm:min-w-28 font-bold"
                style={{ backgroundColor: '#34383C', color: selectedCount === 0 ? '#7A8084' : '#FFFFFF', cursor: selectedCount === 0 ? 'default' : 'pointer' }}
                disabled={selectedCount === 0}
                onMouseEnter={(e) => { if (selectedCount > 0) (e.currentTarget as HTMLButtonElement).style.backgroundColor = '#5A5E62'; }}
                onMouseLeave={(e) => { if (selectedCount > 0) (e.currentTarget as HTMLButtonElement).style.backgroundColor = '#34383C'; }}
              >
                ææ¬¾
              </button>
              <button
                className="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md transition-colors interactive-focus relative select-none h-10 px-4 w-full sm:sm:min-w-28 font-bold"
                style={{ backgroundColor: '#34383C', color: actionButtonDisabled ? '#7A8084' : '#FFFFFF', cursor: actionButtonDisabled ? 'default' : 'pointer' }}
                disabled={actionButtonDisabled}
                onMouseEnter={(e) => { if (!actionButtonDisabled) (e.currentTarget as HTMLButtonElement).style.backgroundColor = '#5A5E62'; }}
                onMouseLeave={(e) => { if (!actionButtonDisabled) (e.currentTarget as HTMLButtonElement).style.backgroundColor = '#34383C'; }}
                onClick={handleToggleMode}
              >
                {actionButtonLabel}
              </button>
            </div>
          </div>
          <div className="bg-gray-800 rounded-lg overflow-y-auto p-4 self-stretch flex-1 min-h-0" style={{ backgroundColor: '#1D2125' }}>
            {shouldShowWarehouseLoading ? (
              <div className="flex h-full sm:h-[150px] items-center justify-center font-semibold" style={{ color: '#7A8084' }}>æ­£åœ¨åŠ è½½ä»“åº“...</div>
            ) : selectedCount === 0 ? (
              <div className="flex h-full sm:h-[150px] items-center justify-center font-semibold" style={{ color: '#7A8084' }}>é€‰æ‹©ç‰©å“æ¥ç®¡ç†å®ƒä»¬</div>
            ) : (
              <div className="h-full w-full grid grid-cols-2 xs:grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-4 grid-rows-[repeat(2,min-content)] sm:grid-rows-[auto]">
                {selectionOrder.filter((id) => selectedItems.has(id)).map((id) => {
                  const it = defaultItems.find((d) => d.id === id);
                  if (!it) return null;
                  return (
                  <div key={it.id} className="aspect-square relative">
                    <button
                      className="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors disabled:pointer-events-none interactive-focus text-base text-white font-bold select-none size-6 min-h-6 min-w-6 max-h-6 max-w-6 rounded-[4px] absolute top-1 right-1"
                      aria-label="remove"
                      onClick={() => toggleSelect(it.id)}
                      style={{ backgroundColor: '#34383C', cursor: 'pointer' }}
                      onMouseEnter={(e) => { (e.currentTarget as HTMLButtonElement).style.backgroundColor = '#5A5E62'; }}
                      onMouseLeave={(e) => { (e.currentTarget as HTMLButtonElement).style.backgroundColor = '#34383C'; }}
                    >
                      <div className="size-4">
                        <svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" clipRule="evenodd" d="M3.29289 3.29289C3.68342 2.90237 4.31658 2.90237 4.70711 3.29289L8 6.58579L11.2929 3.29289C11.6834 2.90237 12.3166 2.90237 12.7071 3.29289C13.0976 3.68342 13.0976 4.31658 12.7071 4.70711L9.41421 8L12.7071 11.2929C13.0976 11.6834 13.0976 12.3166 12.7071 12.7071C12.3166 13.0976 11.6834 13.0976 11.2929 12.7071L8 9.41421L4.70711 12.7071C4.31658 13.0976 3.68342 13.0976 3.29289 12.7071C2.90237 12.3166 2.90237 11.6834 3.29289 11.2929L6.58579 8L3.29289 4.70711C2.90237 4.31658 2.90237 3.68342 3.29289 3.29289Z" fill="currentColor"></path></svg>
                      </div>
                    </button>
                    <div data-component="BaseProductCard" className="group flex flex-col w-full h-full items-center justify-between rounded-lg overflow-hidden transition-colors duration-200 ease-in-out p-3" style={{ boxSizing: 'border-box', backgroundColor: '#22272B' }}>
                      <p className="font-semibold h-6 text-base" style={{ color: '#7A8084' }}></p>
                      <div className="relative flex-1 flex w-full justify-center">
                        <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 aspect-square transition-opacity duration-200 h-5/6 rounded-full opacity-40 md:group-hover:opacity-90 filter blur-[25px] bg-pack-none"></div>
                        {(it.productId?.startsWith('voucher:') || it.name === 'Voucher' || it.price === 0.01) ? (
                          <div className="flex justify-center items-center mx-4 w-full h-full" style={{ zIndex: 1 }}>
                            <div className="flex-1 relative w-full h-full">
                              <div className="absolute top-0 left-0 h-full w-full flex justify-center" dangerouslySetInnerHTML={{ __html: buildVoucherSvg(it.price) }}></div>
                            </div>
                          </div>
                        ) : (
                          <img
                            alt={it.name}
                            src={it.image}
                            style={{ position: 'absolute', height: '100%', width: '100%', inset: '0px', objectFit: 'contain', color: 'transparent', zIndex: 1 }}
                          />
                        )}
                      </div>
                      <div className="flex flex-col w-full gap-0.5">
                        <p className="font-semibold truncate max-w-full text-center text-base" style={{ color: '#7A8084' }}>{it.name}</p>
                        <div className="flex justify-center">
                          <p className="font-extrabold text-base" style={{ color: '#FAFAFA' }}>${it.price.toFixed(2)}</p>
                        </div>
                      </div>
                    </div>
                  </div>
                  );
                })}
              </div>
            )}
          </div>
          {/* å¯è®¤é¢†/ä»·æ ¼/å…¨é€‰å·¥å…·æ¡ï¼ˆä½ç½®ï¼šåˆ—è¡¨å®¹å™¨ä¸‹æ–¹ï¼‰ */}
          <div className="flex justify-between my-3 sm:my-6 gap-2 w-full flex-nowrap rounded-md">
            <div className="gap-2 shrink-0 hidden sm:flex p-2">
              {!isShopMode && (
                <button
                  className="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md transition-colors disabled:pointer-events-none interactive-focus relative h-9 px-3 font-semibold text-sm sm:h-10"
                  style={{ backgroundColor: '#161A1D', color: '#FFFFFF', border: `1px solid ${claimableActive ? '#4299E1' : '#45484A'}`, cursor: 'pointer' }}
                  onMouseEnter={(e) => { (e.currentTarget as HTMLButtonElement).style.backgroundColor = '#3C4044'; }}
                  onMouseLeave={(e) => { (e.currentTarget as HTMLButtonElement).style.backgroundColor = '#161A1D'; }}
                  onClick={() => setClaimableActive(!claimableActive)}
                  type="button"
                >
                  å¯è®¤é¢†ç‰©å“
                </button>
              )}
            </div>
            <div className="flex gap-2 shrink-0 w-full sm:w-auto justify-between p-2">
              <button
                className="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md transition-colors disabled:pointer-events-none interactive-focus relative h-9 px-3 font-semibold text-sm sm:h-10"
                style={{ backgroundColor: '#22272B', color: '#FFFFFF' }}
                onClick={() => setSortByPrice(sortByPrice === 'asc' ? 'desc' : 'asc')}
                type="button"
              >
                ä»·æ ¼
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-arrow-down">
                  <path d="M12 5v14"></path>
                  <path d="m19 12-7 7-7-7"></path>
                </svg>
              </button>
              {!isShopMode && (
                <button
                  className="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md transition-colors disabled:pointer-events-none interactive-focus relative h-9 px-3 font-semibold text-sm group sm:h-10"
                  style={{ backgroundColor: '#22272B', color: '#FFFFFF' }}
                  onClick={selectAll}
                  type="button"
                >
                  <div
                    className="size-5 shrink-0 rounded border flex items-center justify-center transition-all"
                    style={{
                      backgroundColor: (selectedItems.size === defaultItems.length && defaultItems.length > 0) ? '#4299E1' : '#22272B',
                      borderColor: '#5A5E62',
                      borderWidth: 1,
                    }}
                  >
                    {(selectedItems.size === defaultItems.length && defaultItems.length > 0) && (
                      <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#FFFFFF" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round">
                        <path d="M20 6L9 17l-5-5"></path>
                      </svg>
                    )}
                  </div>
                  {(selectedItems.size === defaultItems.length && defaultItems.length > 0) ? 'å–æ¶ˆå…¨é€‰' : `å…¨é€‰ (${defaultItems.length})`}
                </button>
              )}
            </div>
          </div>
          {/* ä»“åº“å•†å“ç½‘æ ¼ï¼ˆåœ¨å·¥å…·æ¡ä¸‹é¢ï¼‰ */}
          {(!warehouseLoading && defaultItems.length > 0) && (
            <div className="flex-1 overflow-y-auto min-h-0">
              <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 pb-4">
                {sortedItems?.length>0&&sortedItems.map((item) => (
                  <CartItemCard
                    key={item.id}
                    item={item}
                    isShopMode={isShopMode}
                    isSelected={selectedItems.has(item.id)}
                    onToggleSelect={() => toggleSelect(item.id)}
                    onSplit={splitMutation.mutate}
                    onSell={(it) => openConfirmForSingle(it)}
                    onBuy={handleBuyShopItem}
                    isBuying={buyingProductId === item.productId && buyShopItemMutation.isPending}
                  />
                ))}
              </div>
            </div>
          )}
        </div>

        {/* å…³é—­æŒ‰é’® */}
        <button
          type="button"
          className="absolute right-5 top-[18px] rounded-lg w-8 h-8 flex items-center justify-center cursor-pointer"
          style={{ color: '#7A8084' }}
          onClick={onClose}
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-x min-w-6 min-h-6 size-6">
            <path d="M18 6 6 18"></path>
            <path d="m6 6 12 12"></path>
          </svg>
          <span className="sr-only">Close</span>
        </button>

        {/* ç¡®è®¤å‡ºå”®å¼¹çª— */}
        {confirmOpen && (
          <div
            className="fixed px-4 inset-0 z-[100] bg-black/[0.48] data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 overflow-y-auto flex justify-center items-start py-16"
            style={{ pointerEvents: 'auto' }}
            onClick={() => { if (!confirmSellMutation.isPending) setConfirmOpen(false); }}
          >
            <div
              role="dialog"
              aria-describedby="sell-confirm-desc"
              aria-labelledby="sell-confirm-title"
              data-state="open"
              className="overflow-hidden z-[110] grid w-full gap-4 p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 rounded-lg relative max-w-2xl"
              tabIndex={-1}
              style={{ pointerEvents: 'auto', backgroundColor: '#161A1D', color: '#FFFFFF', fontFamily: 'Urbanist, sans-serif', fontWeight: 700 }}
              onClick={(e) => e.stopPropagation()}
            >
              <div className="flex flex-col gap-1.5 text-center sm:text-left">
                <h2 id="sell-confirm-title" className="text-xl font-bold leading-none tracking-tight text-left">
                  å‡ºå”® {confirmCount} ä¸ªç‰©å“
                </h2>
              </div>
              <div className="flex flex-col items-start gap-4 py-2" id="sell-confirm-desc">
                <p>æ‚¨çš„ä½™é¢å°†å¢åŠ  ${confirmGain.toFixed(2)}</p>
                <div className="flex flex-col items-start gap-4 rounded-lg p-4" style={{ border: '1px solid #161A1D', backgroundColor: '#161A1D' }}>
                  <p className="font-bold">è¯·æ³¨æ„</p>
                  <p className="text-sm">ä¸€æ—¦æ‚¨å‡ºå”®ç‰©å“ï¼Œå®ƒå°†æ— æ³•æ¢å¤ã€‚è¯·ç¡®ä¿æ‚¨æƒ³è¦å‡ºå”®è¿™äº›ç‰©å“ï¼Œç„¶åå†ç»§ç»­ã€‚</p>
                  <p className="text-sm">æ‚¨çš„ä½™é¢å°†åœ¨é”€å”®å®Œæˆåç«‹å³å…¥è´¦ã€‚</p>
                </div>
              </div>
              <div className="flex flex-col-reverse sm:flex-row sm:justify-end sm:gap-2 gap-2">
                <button
                  className="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md transition-colors disabled:pointer-events-none interactive-focus relative bg-transparent text-base font-bold select-none h-10 px-6"
                  onClick={() => setConfirmOpen(false)}
                  disabled={confirmSellMutation.isPending}
                  style={{ color: '#7A8084', cursor: 'pointer' }}
                  onMouseEnter={(e) => { (e.currentTarget as HTMLButtonElement).style.color = '#FFFFFF'; }}
                  onMouseLeave={(e) => { (e.currentTarget as HTMLButtonElement).style.color = '#7A8084'; }}
                >
                  å–æ¶ˆ
                </button>
                <button
                  className="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md transition-colors disabled:pointer-events-none interactive-focus relative text-base font-bold select-none h-10 px-6"
                  onClick={() => {
                    if (!confirmSellMutation.isPending && confirmPayload.length > 0) {
                      confirmSellMutation.mutate(confirmPayload);
                    }
                  }}
                  disabled={confirmSellMutation.isPending || confirmPayload.length === 0}
                  style={{ backgroundColor: '#4299E1', color: '#FFFFFF', cursor: 'pointer' }}
                >
                  ç»§ç»­
                </button>
              </div>
              <button
                type="button"
                className="absolute right-5 top-[18px] rounded-lg w-8 h-8 flex items-center justify-center cursor-pointer"
                onClick={() => { if (!confirmSellMutation.isPending) setConfirmOpen(false); }}
                style={{ color: '#7A8084' }}
                onMouseEnter={(e) => { (e.currentTarget as HTMLButtonElement).style.color = '#FFFFFF'; }}
                onMouseLeave={(e) => { (e.currentTarget as HTMLButtonElement).style.color = '#7A8084'; }}
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-x min-w-6 min-h-6 size-6">
                  <path d="M18 6 6 18"></path>
                  <path d="m6 6 12 12"></path>
                </svg>
                <span className="sr-only">Close</span>
              </button>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

function SelectedCartItemCard({ item, onRemove }: { item: CartItem; onRemove: () => void }) {
  const isVoucher = item.productId?.startsWith('voucher:') || item.name === 'Voucher' || item.price === 0.01;

  return (
    <div className="relative rounded-lg aspect-square" data-component="BaseProductCard" style={{ backgroundColor: '#22272B' }}>
      <div className="absolute top-1 right-1 z-10">
        <button
          className="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors disabled:pointer-events-none interactive-focus text-base font-bold select-none size-6 min-h-6 min-w-6 max-h-6 max-w-6 rounded-[4px]"
          aria-label="remove"
          onClick={(e) => { e.stopPropagation(); onRemove(); }}
          style={{ backgroundColor: '#34383C', cursor: 'pointer', color: '#FFFFFF' }}
          onMouseEnter={(e) => { (e.currentTarget as HTMLButtonElement).style.backgroundColor = '#5A5E62'; }}
          onMouseLeave={(e) => { (e.currentTarget as HTMLButtonElement).style.backgroundColor = '#34383C'; }}
        >
          <div className="size-4">
            <svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path fillRule="evenodd" clipRule="evenodd" d="M3.29289 3.29289C3.68342 2.90237 4.31658 2.90237 4.70711 3.29289L8 6.58579L11.2929 3.29289C11.6834 2.90237 12.3166 2.90237 12.7071 3.29289C13.0976 3.68342 13.0976 4.31658 12.7071 4.70711L9.41421 8L12.7071 11.2929C13.0976 11.6834 13.0976 12.3166 12.7071 12.7071C12.3166 13.0976 11.6834 13.0976 11.2929 12.7071L8 9.41421L4.70711 12.7071C4.31658 13.0976 3.68342 13.0976 3.29289 12.7071C2.90237 12.3166 2.90237 11.6834 3.29289 11.2929L6.58579 8L3.29289 4.70711C2.90237 4.31658 2.90237 3.68342 3.29289 3.29289Z" fill="currentColor"></path>
            </svg>
          </div>
        </button>
      </div>
      <div className="group flex flex-col w-full h-full items-center justify-between rounded-lg overflow-hidden transition-colors duration-200 ease-in-out p-3 pb-2" style={{ boxSizing: 'border-box', backgroundColor: '#22272B' }}>
        <p className="font-semibold h-6 text-base" style={{ color: '#7A8084' }}></p>
        <div className="relative flex-1 flex w-full justify-center" style={{ minHeight: 0 }}>
          <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 aspect-square transition-opacity duration-200 h-5/6 rounded-full opacity-40 md:group-hover:opacity-90 filter blur-[25px] bg-pack-none"></div>
          {isVoucher ? (
            <div className="flex justify-center items-center mx-4 w-full h-full" style={{ zIndex: 1 }}>
              <div className="flex-1 relative w-full h-full">
                <div className="absolute top-0 left-0 h-full w-full flex justify-center" dangerouslySetInnerHTML={{ __html: buildVoucherSvg(item.price) }}></div>
              </div>
            </div>
          ) : (
            <img
              alt={item.name}
              src={item.image}
              style={{ position: 'absolute', height: '100%', width: '100%', inset: '0px', objectFit: 'contain', color: 'transparent', zIndex: 1 }}
            />
          )}
        </div>
        <div className="flex flex-col w-full gap-0.5">
          <p className="font-semibold truncate max-w-full text-center text-base" style={{ color: '#7A8084' }}>{item.name}</p>
          <div className="flex justify-center">
            <p className="font-extrabold text-base" style={{ color: '#FAFAFA' }}>${item.price.toFixed(2)}</p>
          </div>
        </div>
      </div>
    </div>
  );
}

function CartItemCard({
  item,
  isSelected,
  onToggleSelect,
  onSplit,
  onSell,
  isShopMode,
  onBuy,
  isBuying,
}: {
  item: CartItem;
  isSelected: boolean;
  onToggleSelect: () => void;
  onSplit: (item: CartItem) => void;
  onSell: (item: CartItem) => void;
  isShopMode?: boolean;
  onBuy?: (item: CartItem) => void;
  isBuying?: boolean;
}) {
  const isVoucher = item.productId?.startsWith('voucher:') || item.name === 'Voucher' || item.price === 0.01;
  const [hovered, setHovered] = useState(false);
  const [menuOpen, setMenuOpen] = useState(false);
  const triggerRef = useRef<HTMLButtonElement | null>(null);
  const menuRef = useRef<HTMLDivElement | null>(null);
  const depthForMenu = (item.productId?.startsWith('voucher:') ? Number(item.productId.split(':').pop()) || 1 : 0);
  const menuItems: string[] = depthForMenu >= 2
    ? ['å‡ºå”®ä»·æ ¼ $' + item.price.toFixed(2), 'ç‰©å“è¯¦æƒ…']
    : depthForMenu === 1
    ? ['å‡ºå”®ä»·æ ¼ $' + item.price.toFixed(2), 'åˆ†æˆ 2 ä»½', 'ç‰©å“è¯¦æƒ…']
    : ['å‡ºå”®ä»·æ ¼ $' + item.price.toFixed(2), 'åˆ†æˆ 2 ä»½', 'é¢†å–ç‰©å“', 'ç‰©å“è¯¦æƒ…'];

  useEffect(() => {
    if (!menuOpen) return;
    const onDocClick = (e: MouseEvent) => {
      const target = e.target as Node;
      if (menuRef.current && menuRef.current.contains(target)) return;
      if (triggerRef.current && triggerRef.current.contains(target)) return;
      setMenuOpen(false);
    };
    document.addEventListener('mousedown', onDocClick);
    return () => document.removeEventListener('mousedown', onDocClick);
  }, [menuOpen]);

  const isBuyingState = Boolean(isBuying);
  const actionLabel = isShopMode ? (isBuyingState ? 'è´­ä¹°ä¸­...' : 'è´­ä¹°') : 'å‡ºå”®';

  const handleCardClick = () => {
    if (isShopMode) return;
    onToggleSelect();
  };

  const handleActionClick = (e: ReactMouseEvent<HTMLButtonElement>) => {
    e.stopPropagation();
    if (isShopMode) {
      if (isBuyingState) return;
      onBuy?.(item);
      return;
    }
    onSell?.(item);
  };

  return (
    <div className="relative rounded-lg border" data-component="CartItemCard" style={{ backgroundColor: '#22272B', borderColor: isSelected ? '#4299E1' : '#22272B', borderWidth: 1, cursor: 'default' }}
      onMouseEnter={() => setHovered(true)}
      onMouseLeave={() => { setHovered(false); }}
      onClick={handleCardClick}
    >
      {isShopMode ? null : (
        <div className="absolute top-0.5 left-2 flex gap-2 z-10">
          <button
            className="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md transition-colors disabled:pointer-events-none interactive-focus relative bg-transparent text-base font-bold select-none size-8 min-h-8 min-w-8 max-h-8 max-w-8"
            aria-label="Options"
            type="button"
            onClick={(e) => { e.stopPropagation(); setMenuOpen((o) => !o); }}
            ref={triggerRef}
            style={{ color: '#7A8084', cursor: 'pointer' }}
          >
            <div className="size-5 flex justify-center">
              <svg viewBox="0 0 18 4" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M4.00002 2.00001C4.00002 3.10459 3.10459 4.00002 2.00001 4.00002C0.895433 4.00002 0 3.10459 0 2.00001C0 0.895433 0.895433 0 2.00001 0C3.10459 0 4.00002 0.895433 4.00002 2.00001Z" fill="currentColor"></path>
                <path d="M11 2.00001C11 3.10459 10.1046 4.00002 9.00003 4.00002C7.89545 4.00002 7.00002 3.10459 7.00002 2.00001C7.00002 0.895433 7.89545 0 9.00003 0C10.1046 0 11 0.895433 11 2.00001Z" fill="currentColor"></path>
                <path d="M18.0001 2.00001C18.0001 3.10459 17.1046 4.00002 16.0001 4.00002C14.8955 4.00002 14 3.10459 14 2.00001C14 0.895433 14.8955 0 16.0001 0C17.1046 0 18.0001 0.895433 18.0001 2.00001Z" fill="currentColor"></path>
              </svg>
            </div>
          </button>
          {menuOpen && (
            <div ref={menuRef} style={{ position: 'absolute', left: 0, top: 28, zIndex: 50 }}>
              <div role="menu" aria-orientation="vertical" className="z-50 w-40 rounded-lg p-1 shadow-md" style={{ backgroundColor: '#1D2125', color: '#7A8084', fontFamily: 'Urbanist, sans-serif', fontWeight: 600 }}>
                {menuItems.map((label: string) => (
                  <div key={label}
                    role="menuitem"
                    className="relative flex cursor-pointer select-none items-center gap-2 rounded-lg px-2 py-1.5 text-sm font-semibold"
                    onClick={(e) => {
                      e.stopPropagation();
                      if (label.includes('åˆ†æˆ')) { onSplit(item); setMenuOpen(false); return; }
                      setMenuOpen(false);
                    }}
                    onMouseEnter={(e) => { (e.currentTarget as HTMLDivElement).style.backgroundColor = '#3C4044'; (e.currentTarget as HTMLDivElement).style.color = '#FFFFFF'; }}
                    onMouseLeave={(e) => { (e.currentTarget as HTMLDivElement).style.backgroundColor = 'transparent'; (e.currentTarget as HTMLDivElement).style.color = '#7A8084'; }}
                  >
                    {label}
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      )}
      {isShopMode ? null : (
        <div className="absolute right-2 top-2 shrink-0 transition-opacity duration-200" style={{ opacity: (hovered || isSelected) ? 1 : 0 }}>
          <button
            type="button"
            role="checkbox"
            aria-checked={isSelected}
            data-state={isSelected ? 'checked' : 'unchecked'}
            value="on"
            className="peer shrink-0 rounded border size-5"
            aria-label="Select item"
            onClick={(e) => { e.stopPropagation(); onToggleSelect(); }}
            onMouseEnter={(e) => { (e.currentTarget as HTMLButtonElement).style.cursor = 'pointer'; (e.currentTarget as HTMLButtonElement).style.borderColor = '#4299E1'; }}
            onMouseLeave={(e) => { (e.currentTarget as HTMLButtonElement).style.borderColor = isSelected ? '#4299E1' : '#5A5E62'; }}
            style={{ border: '1px solid ' + (isSelected ? '#4299E1' : (hovered ? '#4299E1' : '#5A5E62')), backgroundColor: isSelected ? '#4299E1' : 'transparent' }}
          >
            <span data-state={isSelected ? 'checked' : 'unchecked'} className="flex items-center justify-center text-current" style={{ pointerEvents: 'none' }}>
              {isSelected && (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-check h-4 w-4 text-white">
                  <path d="M20 6 9 17l-5-5"></path>
                </svg>
              )}
            </span>
          </button>
        </div>
      )}
      <div className="h-32 sm:h-36">
        <div
          data-component="BaseProductCard"
          className="group flex flex-col w-full h-full items-center justify-between rounded-lg overflow-hidden transition-colors duration-200 ease-in-out p-3"
          style={{ boxSizing: 'border-box', backgroundColor: '#22272B' }}
        >
          <p className="font-semibold text-gray-400 h-6 text-sm"></p>
          <div className="relative flex-1 flex w-full justify-center">
            <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 aspect-square transition-opacity duration-200 h-5/6 rounded-full opacity-40 md:group-hover:opacity-90 filter blur-[25px] bg-pack-none"></div>
            {isVoucher ? (
              <div className="flex justify-center items-center mx-4 w-full h-full" style={{ zIndex: 1 }}>
                <div className="flex-1 relative w-full h-full">
                  <div className="absolute top-0 left-0 h-full w-full flex justify-center" dangerouslySetInnerHTML={{ __html: buildVoucherSvg(item.price) }}></div>
                </div>
              </div>
            ) : (
              <img
                alt={item.name}
                src={item.image}
                style={{ position: 'absolute', height: '100%', width: '100%', inset: '0px', objectFit: 'contain', color: 'transparent', zIndex: 1 }}
              />
            )}
          </div>
          <div className="flex flex-col w-full gap-0.5">
            <p className="font-semibold truncate max-w-full text-center text-sm" style={{ color: '#7A8084' }}>{item.name}</p>
            <div className="flex justify-center">
              <p className="font-extrabold text-sm" style={{ color: '#FAFAFA' }}>${item.price.toFixed(2)}</p>
            </div>
          </div>
        </div>
      </div>
      <div className="w-full px-2 pb-2 gap-2">
        <button
          className="inline-flex items-center justify-center gap-2 whitespace-nowrap transition-colors disabled:pointer-events-none interactive-focus relative text-white font-bold select-none h-9 px-6 w-full rounded-lg text-sm"
          disabled={isShopMode ? isBuyingState : false}
          style={{
            backgroundColor: '#34383C',
            cursor: isShopMode ? (isBuyingState ? 'not-allowed' : 'pointer') : 'pointer',
            opacity: isShopMode && isBuyingState ? 0.6 : 1,
          }}
          onMouseEnter={(e) => {
            if (isShopMode && isBuyingState) return;
            (e.currentTarget as HTMLButtonElement).style.backgroundColor = '#5A5E62';
          }}
          onMouseLeave={(e) => { (e.currentTarget as HTMLButtonElement).style.backgroundColor = '#34383C'; }}
          onClick={handleActionClick}
        >
          {actionLabel}
        </button>
      </div>
    </div>
  );
}

