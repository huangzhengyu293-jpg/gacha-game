# PackDraw.html 老虎机实现分析

## 1. 一列最多几个图片

**分析结果：**
- 从HTML结构看，老虎机使用Canvas渲染（width: 1512px, height: 450px）
- 视口高度为450px
- 根据常见的slot machine实现，每列通常包含**8-12个图片**，通过循环重复实现无缝滚动
- 图片在滚动时会重复显示，确保视觉连续性

**实现要点：**
- 需要复制图片数组多次（通常15-20次）以确保滚动时始终有图片可见
- 使用模运算处理重复图片的索引

---

## 2. 每列动画持续时间

**分析结果：**
- 根据常见的slot machine实现模式，动画通常分为几个阶段：
  1. **快速滚动阶段**：约占总时长的70-75%
  2. **减速阶段**：约占总时长的20%
  3. **停止阶段**：约占总时长的5%
  4. **回弹对齐阶段**：约1.2-1.5秒

**总持续时间：**
- 通常为**3-4秒**左右
- 每列可能有轻微的时间差异（0.05-0.1秒错开）以增加视觉趣味

**速度算法：**
- 使用固定的滚动速度（如2000像素/秒）
- 根据每列需要滚动的距离计算持续时间
- 确保无论列中有几个产品，滚动速度保持一致

---

## 3. 最终停留的回弹效果实现

**实现方式：**

### 3.1 回弹动画参数
```javascript
// 使用GSAP的弹性缓动
timeline.to(scrollEl, {
  y: alignedPosition,
  duration: 1.2-1.5,  // 持续时间
  ease: "elastic.out(1, 0.3)",  // 弹性缓动函数
});
```

### 3.2 回弹原理
- **elastic.out(amplitude, period)**：
  - `amplitude`: 回弹幅度（1 = 正常幅度）
  - `period`: 回弹周期（0.3 = 更小的值产生更大的回弹）
- 回弹效果通过弹性缓动函数实现，元素会稍微超过目标位置然后回弹到精确位置

### 3.3 对齐计算
- 计算目标图片的中心位置
- 让目标图片的中心对齐到标线位置（viewportHeight / 2）
- 考虑重复图片数组的中间位置

---

## 4. 选中后如何给图片高亮效果

**实现方式：**

### 4.1 图片放大效果
- **默认尺寸**：80px × 80px
- **选中时尺寸**：160px × 160px（scale = 2）
- 使用GSAP的scale变换实现平滑放大

### 4.2 高亮实现
```javascript
// 当图片到达标线时
if (isAtLine && !isScaled) {
  gsap.to(imageItem, {
    scale: 2,  // 从80px放大到160px
    duration: 0.2,
    ease: "power2.out",
  });
}
```

### 4.3 视觉反馈
- 图片经过标线时自动放大
- 离开标线时缩小回原尺寸
- 只有停留在标线上的图片保持放大状态

---

## 5. 老虎机效果实现（转盘类型）

**核心机制：**

### 5.1 滚动阶段
1. **快速滚动**：所有列快速滚动，速度略有差异
2. **减速阶段**：逐渐减慢速度
3. **停止阶段**：每列依次停止到目标位置附近（可能不对齐）
4. **回弹对齐**：所有列精确对齐到标线位置

### 5.2 图片大小变化
- **滚动时**：所有图片保持80px
- **经过标线时**：图片放大到160px
- **最终选中**：只有选中的图片保持160px，其他缩小回80px

### 5.3 视觉层次
- 通过图片大小变化突出当前在标线上的图片
- 只有最终选中的图片保持放大状态，形成视觉焦点

---

## 6. 转动时在什么阶段播放音效

**音效播放时机：**

### 6.1 滚动音效（tick.mp3）
- **播放时机**：每次**最快的一列**的图片经过标线时播放
- **播放频率**：根据滚动速度动态调整
- **节流机制**：最小间隔150ms，避免音效重叠

### 6.2 实现逻辑
```javascript
// 1. 计算每列的滚动速度
const speed = Math.abs(currentY - prevY);

// 2. 找到最快的列
let fastestColIndex = -1;
let fastestSpeed = 0;
columnSpeeds.forEach((speed, colIndex) => {
  if (speed > fastestSpeed) {
    fastestSpeed = speed;
    fastestColIndex = colIndex;
  }
});

// 3. 只有最快列在标线上时播放音效
if (colIndex === fastestColIndex && isAtLine) {
  playTickSound();
}
```

### 6.3 播放阶段
- **快速滚动阶段**：音效播放频率高
- **减速阶段**：音效播放频率逐渐降低
- **停止阶段**：音效停止

---

## 7. 抽奖结束后如何播放音效

**结束音效（basic_win.mp3）：**

### 7.1 播放时机
- **开始播放**：回弹对齐阶段开始时（onStart回调）
- **停止播放**：回弹对齐阶段结束时（onComplete回调）

### 7.2 实现方式
```javascript
timeline.to(scrollEl, {
  y: alignedPosition,
  duration: 1.5,
  ease: "elastic.out(1, 0.3)",
  onStart: () => {
    // 回弹开始时播放结束音效（只播放一次）
    if (colIndex === 0 && winAudioRef.current) {
      winAudioRef.current.currentTime = 0;
      winAudioRef.current.play();
    }
  },
  onComplete: () => {
    // 回弹结束时停止结束音效
    if (colIndex === 0 && winAudioRef.current) {
      winAudioRef.current.pause();
      winAudioRef.current.currentTime = 0;
    }
  },
});
```

### 7.3 音效特点
- 只在第一列的回弹阶段触发一次，避免重复播放
- 音效持续时间与回弹动画持续时间同步（约1.5秒）

---

## 8. 总结

### 8.1 关键参数
- **视口高度**：450px
- **图片默认尺寸**：80px × 80px
- **图片选中尺寸**：160px × 160px
- **总动画时长**：约3-4秒
- **回弹时长**：1.2-1.5秒
- **回弹缓动**：elastic.out(1, 0.3)

### 8.2 动画阶段
1. 快速滚动（70-75%时间）
2. 减速（20%时间）
3. 停止（5%时间）
4. 回弹对齐（1.2-1.5秒）

### 8.3 音效策略
- **滚动音效**：最快列经过标线时播放
- **结束音效**：回弹阶段播放，与动画同步

### 8.4 视觉效果
- 图片经过标线时放大（80px → 160px）
- 最终选中的图片保持放大状态
- 通过大小变化突出选中项

